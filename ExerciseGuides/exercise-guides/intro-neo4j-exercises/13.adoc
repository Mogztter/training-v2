= Exercise 13
== Exercise 13: Analyzing and monitoring queries

=== Preparations

Make sure you have the Movie database, which contains 173 nodes and 257 relationships.

This is what you should see when you click the database icon:

image::{guides}/img/AfterExercise11.png[After exercise 11,200,200, role=left]

If your database does not have this number of nodes and relationships, you can use the script below to reset it:

[source, cypher]
----
include::scripts/AfterExercise11.cypher[]
----


== Exercise Overview

In this exercise you will look at metrics for a query during query planning (`EXPLAIN`) and during query execution (`PROFILE`).
Then you will monitor a long-running query and kill it.

. In Part 1, you view query metrics.
. In Part 2, you monitor and kill long-running queries.

Go to the next page to perform the two parts of this exercise.

== Instructions, Exercise 13, Part 1
.*Viewing query metrics*

For this Part of the exercise, you will use the query that you wrote previously using Cypher parameters.
It assumes that you have set the _year_ and _ratingValue_ Cypher parameters:

[source, cypher]
----
MATCH (r:Person)-[rel:REVIEWED]->(m:Movie)<-[:ACTED_IN]-(a:Person)
WHERE m.released = $year AND
      rel.rating > $ratingValue
RETURN  DISTINCT r.name, m.title, m.released, rel.rating, collect(a.name)
----

Perform these steps:

. View the query plan for this Cypher statement.
. View the metrics for the query when this statement executes.
. Remove the labels from the nodes and relationships and again view the metrics.
Compare the db hits from the previous version of the statement.

== Solution, Exercise 13, Part 1
.*Viewing query metrics*

For this Part of the exercise, you will use the query that you wrote previously using Cypher parameters.
It assumes that you have set the _year_ and _ratingValue_ Cypher parameters:

[source, cypher]
----
MATCH (r:Person)-[rel:REVIEWED]->(m:Movie)<-[:ACTED_IN]-(a:Person)
WHERE m.released = $year AND
      rel.rating > $ratingValue
RETURN  DISTINCT r.name, m.title, m.released, rel.rating, collect(a.name)
----

Perform these steps:

*1. View the query plan for this Cypher statement.*

[source, cypher]
----
EXPLAIN MATCH (r:Person)-[rel:REVIEWED]->(m:Movie)<-[:ACTED_IN]-(a:Person)
WHERE m.released = $year AND
      rel.rating > $ratingValue
RETURN  DISTINCT r.name, m.title, m.released, rel.rating, collect(a.name)
----

When the result returned should be:

[.thumb]
image::{guides}/img/EXPLAIN.png[EXPLAIN,width=500]

*2. View the metrics for the query when this statement executes.*

[source, cypher]
----
PROFILE MATCH (r:Person)-[rel:REVIEWED]->(m:Movie)<-[:ACTED_IN]-(a:Person)
WHERE m.released = $year AND
      rel.rating > $ratingValue
RETURN  DISTINCT r.name, m.title, m.released, rel.rating, collect(a.name)
----

The result returned should look something like this:
[.thumb]
image::{guides}/img/PROFILE.png[PROFILE,width=500]


*3. Remove the labels from the nodes and relationships and again view the metrics.
Compare the db hits from the previous version of the statement.*

[source, cypher]
----
PROFILE MATCH (r)-[rel]->(m)<-[:ACTED_IN]-(a)
WHERE m.released = $year AND
      rel.rating > $ratingValue
RETURN  DISTINCT r.name, m.title, m.released, rel.rating, collect(a.name)
----

The result returned should be:

[.thumb]
image::{guides}/img/PROFILE2.png[PROFILE2,width=500]

You should see more db hits.
This is because you removed the labels that help to filter nodes and relationships during the query.

Next, Part 2

== Instructions, Exercise 13, Part 2
.*Monitoring and killing a query*

Recall that a query may run for a long time because:

* There are a lot of results to return
* The query takes a long time to execute in the graph engine.

You will perform these steps to gain some experience with monitoring and killing queries by having your original Neo4j Browser window open and then opening another Neo4j Browser window:

. Open a second Neo4j Browser session.
This session will be used for monitoring queries as they run.
. Execute this long-running query in your original Neo4j Browser session that returns a lot of results.
In the second Neo4j Browser window, monitor the running queries.

Here is a very bad Cypher statement to use that returns a lot of results:
[source, cypher]
----
PROFILE MATCH (a)--(b)--(c)--(d)--(e)--(f)--(g)
RETURN a
----
What do you see in the second Neo4j Browser window where you are monitoring queries?
[start=3]
. Execute this long-running query in your original Neo4j Browser session and monitor the query in the second Neo4j Browser session.

Here is a very bad Cypher statement that takes a lot of time to execute in the graph engine:
[source, cypher]
----
PROFILE MATCH (a), (b), (c), (d), (e) , (f), (g)
RETURN count(id(a))
----
What do you see in the second Neo4j Browser window where you are monitoring queries?
[start=4]
. In the second Neo4j Browser window, kill the long-running query.

What do you see in the original Neo4j Browser window?

== Solution, Exercise 13, Part 2
.*Monitoring and killing a query*

Recall that a query may run for a long time because:

* There are a lot of results to return
* The query takes a long time to execute in the graph engine.

You will perform these steps to gain some experience with monitoring and killing queries by having your original Neo4j Browser window open and then opening another Neo4j Browser window:

*1. Open a second Neo4j Browser session.
This session will be used for monitoring queries as they run.*

If you are using Neo4j Desktop, open a Web browser window and enter http://localhost:7474 which opens a second Neo4j Browser window that has access to the same graph.

[.thumb]
image::{guides}/img/SecondBrowserWindowDesktop.png[SecondBrowserWindowDesktop,width=500]

If you are using a Neo4j Sandbox, go the the Sandbox site and simply click on the Neo4j Browser to open a second window for that same graph.

[.thumb]
image::{guides}/img/SecondBrowserSandbox.png[SecondBrowserSandbox,width=500]

*2. Execute this long-running query in your original Neo4j Browser session that returns a lot of results.
In the second Neo4j Browser window, monitor the running queries.* 

Here is a very bad Cypher statement to use that returns a lot of results:
[source, cypher]
----
PROFILE MATCH (a)--(b)--(c)--(d)--(e)--(f)--(g)
RETURN a
----

What do you see in the second Neo4j Browser window where you are monitoring queries?

While the query in the original Neo4j Browser window is executing, you should see this in the second Neo4j Browser window:

[.thumb]
image::{guides}/img/LongRunningReturn.png[LongRunningReturn,width=600]

This is because the graph engine has completed the query and the results are being streamed.

*3. Execute this long-running query in your original Neo4j Browser session and monitor the query in the second Neo4j Browser session.*

Here is a very bad Cypher statement that takes a lot of time to execute in the graph engine:
[source, cypher]
----
PROFILE MATCH (a), (b), (c), (d), (e) , (f), (g)
RETURN count(id(a))
----

What do you see in the second Neo4j Browser window where you are monitoring queries?

You should see this in the second Neo4j Browser window:
[.thumb]
image::{guides}/img/LongRunningQuery.png[LongRunningQuery,width=600]

*4. In the second Neo4j Browser window, kill the long-running query.*

[.thumb]
image::{guides}/img/KillLongRunningQuery.png[KillLongRunningQuery,width=600]


What do you see in the original Neo4j Browser window?

[.thumb]
image::{guides}/img/LongRunningQueryKiilled.png[LongRunningQueryKiilled,width=600]

== Exercise Summary

In this exercise you gained experience analyzing metrics for queries, monitoring queries, and killing queries.

pass:a[<a play-topic='{guides}/14.html'>Continue to Exercise 14</a>]
