<style type="text/css" media="screen">
/*
.nodes-image {
	margin:-100;
}
*/	
@import url("//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css");

.imageblock .content img, .image img {max-width: 900px;max-height: 300px;}
.deck h3, .deck h4 {display: block !important;margin-bottom:8px;margin-top:5px;}
.listingblock {margin:8px;}
.pull-bottom {position:relative;bottom:1em;}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.admonitionblock.note.speaker { display:none; }
</style>
<style type="text/css" media="screen">
/* #editor.maximize-editor .CodeMirror-code { font-size:24px; line-height:26px; } */
</style>
<article class="guide" ng-controller="AdLibDataController">
  <carousel class="deck container-fluid">
    <!--slide class="row-fluid">
      <div class="col-sm-3">
        <h3>Exercise 6</h3>
        <p class="lead">Information</p>
			<!dl>
				
				
				
				
				
			</dl>
		</div>
      <div class="col-sm-9">
        <figure>
          <img style="width:300px" src=""/>
        </figure>
      </div>
    </slide-->
    


   <h4>Exercise 6</h4>
   


<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6: Loading denormalized data (Preparations)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p><strong>Verify that your Neo4j Browser session has access to the APOC library by executing the Cypher below</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable programlisting cm-s-neo code runnable standalone-example ng-binding" data-lang="cypher" lang="cypher"><!--code class="cypher language-cypher"-->CALL dbms.procedures()
YIELD name
WHERE name STARTS WITH 'apoc.'
RETURN name ORDER BY name ASC<!--/code--></pre>
</div>
</div>
<div class="paragraph">
<p>If this code does not return the list of APOC procedures, then you must ensure that the APOC library is available by installing the plugin (Neo4j Desktop) and restarting the database as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure Neo4j Desktop is online.</p>
</li>
<li>
<p>In Neo4j Desktop for the project you are working with, click  <strong>Add Plugin</strong>.</p>
</li>
<li>
<p>Select the install button for APOC.</p>
</li>
<li>
<p>Click the Install button.</p>
</li>
<li>
<p>Close the Add Plugin window.</p>
</li>
<li>
<p>Start or restart the database.</p>
</li>
</ol>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6: Loading denormalized data (Overview)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p>In this exercise, you will first remove all data and indexes from the database so you can start fresh, then  you will load denormalized data into the database.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Exercise 6.1</strong>: Remove all nodes, relationships, and indexes from the database.</p>
</li>
<li>
<p><strong>Exercise 6.2</strong>: Determine how large the dataset is that you will be loading.</p>
</li>
<li>
<p><strong>Exercise 6.3</strong>: Examine the data you will be loading.</p>
</li>
<li>
<p><strong>Exercise 6.4</strong>: Create the constraints.</p>
</li>
<li>
<p><strong>Exercise 6.5</strong>: Load the movie and person data by merging the movie data from the row and then the person data.</p>
</li>
<li>
<p><strong>Exercise 6.6</strong>: Remove all nodes and relationships from the database and then profile the same load.</p>
</li>
<li>
<p><strong>Exercise 6.7</strong>: Remove all nodes and relationships from the database.</p>
</li>
<li>
<p><strong>Exercise 6.8</strong>: Load and merge the movie data while collecting the person data, then use unwind to merge the person data.</p>
</li>
<li>
<p><strong>Exercise 6.9</strong>: Create the indexes.</p>
</li>
<li>
<p><strong>Exercise 6.10</strong>: Create the <code>Genre</code> nodes and <code>:IS_GENRE</code> relationships.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Go to the next page to start this exercise.</p>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6.1: Remove all nodes, relationships, and indexes from the database. (Instructions)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p><strong>To start with a database that contains no data or indexes, run this code just like you did in the previous exercise:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable programlisting cm-s-neo code runnable standalone-example ng-binding" data-lang="cypher" lang="cypher"><!--code class="cypher language-cypher"-->// Remove all indexes and constraints
CALL apoc.schema.assert({},{},true);
// Remove all nodes/relationships
MATCH (n:Person) DETACH DELETE n;
MATCH (n:Director) DETACH DELETE n;
MATCH (n:Actor) DETACH DELETE n;
MATCH (n:Movie) DETACH DELETE n;
MATCH (n:Genre) DETACH DELETE n<!--/code--></pre>
</div>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6.1: Remove all nodes, relationships, and indexes from the database. (Solution)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p><strong>To start with a database that contains no data or indexes, run this code just like you did in the previous exercise:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable programlisting cm-s-neo code runnable standalone-example ng-binding" data-lang="cypher" lang="cypher"><!--code class="cypher language-cypher"-->// Remove all indexes and constraints
CALL apoc.schema.assert({},{},true);
// Remove all nodes/relationships
MATCH (n:Person) DETACH DELETE n;
MATCH (n:Director) DETACH DELETE n;
MATCH (n:Actor) DETACH DELETE n;
MATCH (n:Movie) DETACH DELETE n;
MATCH (n:Genre) DETACH DELETE n<!--/code--></pre>
</div>
</div>
<div class="paragraph">
<p>The results returned should look like this:</p>
</div>
<div class="imageblock thumb">
<div class="content">
<img src="https://guides.neo4j.com/advanced-cypher-exercises/img/EX6.1.png" alt="EX6.1" width="300">
</div>
</div>
<div class="paragraph">
<p>The database should have no nodes and relationships.</p>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6.2: Determine how large the dataset is that you will be loading. (Instructions)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p>The dataset containing the denormalized data is found here:</p>
</div>
<div class="paragraph">
<p><a href="https://data.neo4j.com/advanced-cypher/movies2.csv" class="bare">https://data.neo4j.com/advanced-cypher/movies2.csv</a></p>
</div>
<div class="paragraph">
<p><strong>Write Cypher code to return the number of lines in this file.</strong></p>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6.2: Determine how large the dataset is that you will be loading. (Solution)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p>The dataset containing the denormalized data is found here:</p>
</div>
<div class="paragraph">
<p><a href="https://data.neo4j.com/advanced-cypher/movies2.csv" class="bare">https://data.neo4j.com/advanced-cypher/movies2.csv</a></p>
</div>
<div class="paragraph">
<p><strong>Write Cypher code to return the number of lines in this file.</strong></p>
</div>
<div class="paragraph">
<p>Here is the solution code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable programlisting cm-s-neo code runnable standalone-example ng-binding" data-lang="cypher" lang="cypher"><!--code class="cypher language-cypher"-->LOAD CSV WITH HEADERS FROM
     'https://data.neo4j.com/advanced-cypher/movies2.csv' AS rows
RETURN count(rows) as FileRows<!--/code--></pre>
</div>
</div>
<div class="paragraph">
<p>The results returned should look like this:</p>
</div>
<div class="imageblock thumb">
<div class="content">
<img src="https://guides.neo4j.com/advanced-cypher-exercises/img/EX6.2.png" alt="EX6.2" width="300">
</div>
</div>
<div class="paragraph">
<p>&#160;<br></p>
</div>
<div class="paragraph">
<p>The number of rows in this file is &lt; 100K so we should not need any special loading options (like <code>USING PERIODIC COMMIT</code>).</p>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6.3: Examine the data you will be loading. (Instructions)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p>Since this is denormalized data, you will need to examine more rows to understand how the data has been normalized.</p>
</div>
<div class="paragraph">
<p><strong>Write a query to return the first 50 rows of the CSV file. Make a note of the header names and if IDs are being used to uniquely identify people and movies.</strong></p>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6.3: Examine the data you will be loading. (Solution)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p>Since this is denormalized data, you will need to examine more rows to understand how the data has been normalized.</p>
</div>
<div class="paragraph">
<p><strong>Write a query to return the first 50 rows of the CSV file. Make a note of the header names and if IDs are being used to uniquely identify people and movies.</strong></p>
</div>
<div class="paragraph">
<p>Here is the solution code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable programlisting cm-s-neo code runnable standalone-example ng-binding" data-lang="cypher" lang="cypher"><!--code class="cypher language-cypher"-->LOAD CSV WITH HEADERS FROM
     'https://data.neo4j.com/advanced-cypher/movies2.csv' AS rows
RETURN rows LIMIT 50<!--/code--></pre>
</div>
</div>
<div class="paragraph">
<p>The results should be:</p>
</div>
<div class="imageblock thumb">
<div class="content">
<img src="https://guides.neo4j.com/advanced-cypher-exercises/img/EX6.3.png" alt="EX6.3" width="300">
</div>
</div>
<div class="paragraph">
<p>&#160;<br></p>
</div>
<div class="paragraph">
<p>Notice that each row has movie data and person data. Each row uses a <code>movieId</code> and <code>personId</code> to uniquely identify a movie or person. A row also has a field, <code>personType</code>, where the field will either have a value, "ACTOR" or a value, "DIRECTOR".</p>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6.4: Create the constraints. (Instructions)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p>The <strong>movies2.csv</strong> fields will be mapped to <code>Movie</code> and <code>Person</code> node properties as follows:</p>
</div>
<div class="paragraph">
<p>For <code>Movie</code> nodes:</p>
</div>
<table class="table tableblock frame-none grid-all" style="width: 100%;">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>row field</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>property</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">movieId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">title</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">title</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">avgVote</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">avgVote</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">releaseYear</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">releaseYear</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">genres</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">genres</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Note</strong>: The tagline data will not be loaded.</p>
</div>
<div class="paragraph">
<p>For <code>Person</code> nodes:</p>
</div>
<table class="table tableblock frame-none grid-all" style="width: 100%;">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>row field</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>property</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">personId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">birthYear</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">born</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deathYear</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">died</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>To improve loading when nodes are created using <code>MERGE</code>, add uniqueness constraints as follows, just as you did for the normalized data:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Uniqueness constraint on the <code>id</code> property of a <code>Movie</code> node.</strong></p>
</li>
<li>
<p><strong>Uniqueness constraint on the <code>id</code> property of a <code>Person</code> node.</strong></p>
</li>
</ul>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6.4: Create the constraints. (Solution)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p>The <strong>movies2.csv</strong> fields will be mapped to <code>Movie</code> and <code>Person</code> node properties as follows:</p>
</div>
<div class="paragraph">
<p>For <code>Movie</code> nodes:</p>
</div>
<table class="table tableblock frame-none grid-all" style="width: 100%;">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>row field</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>property</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">movieId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">title</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">title</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">avgVote</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">avgVote</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">releaseYear</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">releaseYear</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">genres</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">genres</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Note</strong>: The tagline data will not be loaded.</p>
</div>
<div class="paragraph">
<p>For <code>Person</code> nodes:</p>
</div>
<table class="table tableblock frame-none grid-all" style="width: 100%;">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>row field</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>property</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">personId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">birthYear</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">born</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deathYear</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">died</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>To improve loading when nodes are created using <code>MERGE</code>, add uniqueness constraints as follows, just as you did for the normalized data:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Uniqueness constraint on the <code>id</code> property of a <code>Movie</code> node.</strong></p>
</li>
<li>
<p><strong>Uniqueness constraint on the <code>id</code> property of a <code>Person</code> node.</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is the solution code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable programlisting cm-s-neo code runnable standalone-example ng-binding" data-lang="cypher" lang="cypher"><!--code class="cypher language-cypher"-->CREATE CONSTRAINT ON (m:Movie)
ASSERT m.id IS UNIQUE;

CREATE CONSTRAINT ON (p:Person)
ASSERT p.id IS UNIQUE<!--/code--></pre>
</div>
</div>
<div class="paragraph">
<p>The results returned should look like this:</p>
</div>
<div class="imageblock thumb">
<div class="content">
<img src="https://guides.neo4j.com/advanced-cypher-exercises/img/EX6.4.png" alt="EX6.4" width="300">
</div>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6.5: Load the movie and person data by merging the movie data from the row and then the person data. (Instructions)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p>The <strong>movies2.csv</strong> fields will be mapped to <code>Movie</code> and <code>Person</code> node properties as follows:</p>
</div>
<div class="paragraph">
<p>For <code>Movie</code> nodes:</p>
</div>
<table class="table tableblock frame-none grid-all" style="width: 100%;">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>row field</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>property</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">movieId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">title</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">title</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">avgVote</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">avgVote</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">releaseYear</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">releaseYear</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">genres</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">genres</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Note</strong>: The tagline data will not be loaded.</p>
</div>
<div class="paragraph">
<p>For <code>Person</code> nodes:</p>
</div>
<table class="table tableblock frame-none grid-all" style="width: 100%;">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>row field</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>property</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">personId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">birthYear</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">born</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deathYear</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">died</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Load the movies2.csv file to:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Use <code>MERGE</code> to create the <code>Movie</code> node.</strong></p>
</li>
<li>
<p><strong>Use <code>MERGE</code> to create the <code>Person</code> node.</strong></p>
</li>
<li>
<p><strong>Use conditional processing to create the relationships, <code>:DIRECTED</code> and <code>:ACTED_IN</code> (using apoc.do.when).</strong></p>
</li>
</ol>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6.5: Load the movie and person data by merging the movie data from the row and then the person data. (Solution)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p>The <strong>movies2.csv</strong> fields will be mapped to <code>Movie</code> and <code>Person</code> node properties as follows:</p>
</div>
<div class="paragraph">
<p>For <code>Movie</code> nodes:</p>
</div>
<table class="table tableblock frame-none grid-all" style="width: 100%;">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>row field</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>property</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">movieId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">title</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">title</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">avgVote</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">avgVote</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">releaseYear</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">releaseYear</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">genres</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">genres</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Note</strong>: The tagline data will not be loaded.</p>
</div>
<div class="paragraph">
<p>For <code>Person</code> nodes:</p>
</div>
<table class="table tableblock frame-none grid-all" style="width: 100%;">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>row field</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>property</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">personId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">id</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">birthYear</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">born</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deathYear</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">died</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Load the movies2.csv file to:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Use <code>MERGE</code> to create the <code>Movie</code> node.</strong></p>
</li>
<li>
<p><strong>Use <code>MERGE</code> to create the <code>Person</code> node.</strong></p>
</li>
<li>
<p><strong>Use conditional processing to create the relationships, <code>:DIRECTED</code> and <code>:ACTED_IN</code> (using apoc.do.when).</strong></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Here is the solution code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable programlisting cm-s-neo code runnable standalone-example ng-binding" data-lang="cypher" lang="cypher"><!--code class="cypher language-cypher"-->LOAD CSV WITH HEADERS FROM 'https://data.neo4j.com/advanced-cypher/movies2.csv' AS row
MERGE (m:Movie {id:toInteger(row.movieId)})
   ON CREATE SET m.title=row.title, m.avgVote=toFloat(row.avgVote),
      m.releaseYear=toInteger(row.releaseYear), m.genres=split(row.genres,":")
MERGE (p:Person {id: toInteger(row.personId)})
   ON CREATE SET p.name = row.name, p.born = toInteger(row.birthYear),
      p.died = toInteger(row.deathYear)
WITH row, m, p
CALL apoc.do.when(row.personType = 'ACTOR',
     "MERGE (p)-[:ACTED_IN {roles: split(coalesce(row.characters,''), ':')}]-&gt;(m)
          ON CREATE SET p:Actor",
     "MERGE (p)-[:DIRECTED]-&gt;(m)
          ON CREATE SET p:Director",
      {row:row, m:m, p:p}) YIELD value AS value
SET p:Person  // cannot end query with APOC call<!--/code--></pre>
</div>
</div>
<div class="paragraph">
<p>The results returned should look like this:</p>
</div>
<div class="imageblock thumb">
<div class="content">
<img src="https://guides.neo4j.com/advanced-cypher-exercises/img/EX6.5.png" alt="EX6.5" width="300">
</div>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6.6: Remove all nodes and relationships from the database and then profile the same load. (Instructions)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p><strong>1. Execute this code to remove all nodes and relationships in the database:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable programlisting cm-s-neo code runnable standalone-example ng-binding" data-lang="cypher" lang="cypher"><!--code class="cypher language-cypher"-->MATCH (n:Person) DETACH DELETE n;

MATCH (n:Director) DETACH DELETE n;

MATCH (n:Actor) DETACH DELETE n;

MATCH (n:Movie) DETACH DELETE n<!--/code--></pre>
</div>
</div>
<div class="paragraph">
<p>&#160;<br></p>
</div>
<div class="paragraph">
<p><strong>2. Profile the previously executed load.</strong></p>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6.6: Remove all nodes and relationships from the database and then profile the same load. (Solution)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p><strong>1. Execute this code to remove all nodes and relationships in the database:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable programlisting cm-s-neo code runnable standalone-example ng-binding" data-lang="cypher" lang="cypher"><!--code class="cypher language-cypher"-->MATCH (n:Person) DETACH DELETE n;

MATCH (n:Director) DETACH DELETE n;

MATCH (n:Actor) DETACH DELETE n;

MATCH (n:Movie) DETACH DELETE n<!--/code--></pre>
</div>
</div>
<div class="paragraph">
<p>&#160;<br></p>
</div>
<div class="paragraph">
<p><strong>2. Profile the previously executed load.</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable programlisting cm-s-neo code runnable standalone-example ng-binding" data-lang="cypher" lang="cypher"><!--code class="cypher language-cypher"-->PROFILE LOAD CSV WITH HEADERS FROM 'https://data.neo4j.com/advanced-cypher/movies2.csv' AS row
MERGE (m:Movie {id:toInteger(row.movieId)})
   ON CREATE SET m.title=row.title, m.avgVote=toFloat(row.avgVote),
      m.releaseYear=toInteger(row.releaseYear), m.genres=split(row.genres,":")
MERGE (p:Person {id: toInteger(row.personId)})
   ON CREATE SET p.name = row.name, p.born = toInteger(row.birthYear),
      p.died = toInteger(row.deathYear)
WITH row, m, p
CALL apoc.do.when(row.personType = 'ACTOR',
     "MERGE (p)-[:ACTED_IN {roles: split(coalesce(row.characters,''), ':')}]-&gt;(m)
          ON CREATE SET p:Actor",
     "MERGE (p)-[:DIRECTED]-&gt;(m)
          ON CREATE SET p:Director",
      {row:row, m:m, p:p}) YIELD value AS value
SET p:Person  // cannot end query with APOC call<!--/code--></pre>
</div>
</div>
<div class="paragraph">
<p>The results returned should look like this:</p>
</div>
<div class="imageblock thumb">
<div class="content">
<img src="https://guides.neo4j.com/advanced-cypher-exercises/img/EX6.6.png" alt="EX6.6" width="300">
</div>
</div>
<div class="paragraph">
<p>&#160;<br></p>
</div>
<div class="paragraph">
<p>This load required 347,703 DB hits.</p>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6.7: Remove all nodes and relationships from the database. (Instructions)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p><strong>Next, you will try another alternative for loading the denormalized data so you should execute this code the remove all existing nodes and relationships:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable programlisting cm-s-neo code runnable standalone-example ng-binding" data-lang="cypher" lang="cypher"><!--code class="cypher language-cypher"-->// Remove all nodes/relationships
MATCH (n:Person) DETACH DELETE n;
MATCH (n:Director) DETACH DELETE n;
MATCH (n:Actor) DETACH DELETE n;
MATCH (n:Movie) DETACH DELETE n<!--/code--></pre>
</div>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6.7: Remove all nodes and relationships from the database. (Solution)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p><strong>Next, you will try another alternative for loading the denormalized data so you should execute this code the remove all existing nodes and relationships:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable programlisting cm-s-neo code runnable standalone-example ng-binding" data-lang="cypher" lang="cypher"><!--code class="cypher language-cypher"-->// Remove all nodes/relationships
MATCH (n:Person) DETACH DELETE n;
MATCH (n:Director) DETACH DELETE n;
MATCH (n:Actor) DETACH DELETE n;
MATCH (n:Movie) DETACH DELETE n<!--/code--></pre>
</div>
</div>
<div class="paragraph">
<p>The results returned should look like this:</p>
</div>
<div class="imageblock thumb">
<div class="content">
<img src="https://guides.neo4j.com/advanced-cypher-exercises/img/EX6.7.png" alt="EX6.7" width="300">
</div>
</div>
<div class="paragraph">
<p>The database should have no nodes and relationships.</p>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6.8: Load and merge the movie data while collecting the person data, then use unwind to merge the person data. (Instructions)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p><strong>Load the movie data while collecting the person data, then use unwind to merge the person data. Just like you did previously, <code>CALL apoc.doc.when()</code> to add the relationships. Profile this load.</strong></p>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6.8: Load and merge the movie data while collecting the person data, then use unwind to merge the person data. (Solution)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p><strong>Load the movie data while collecting the person data, then use unwind to merge the person data. Just like you did previously, <code>CALL apoc.doc.when()</code> to add the relationships. Profile this load.</strong></p>
</div>
<div class="paragraph">
<p>Here is the solution code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable programlisting cm-s-neo code runnable standalone-example ng-binding" data-lang="cypher" lang="cypher"><!--code class="cypher language-cypher"-->PROFILE LOAD CSV WITH HEADERS FROM
     'https://data.neo4j.com/advanced-cypher/movies2.csv' AS row
WITH row.movieId as movieId, row.title as title, row.genres as genres,
toInteger(row.releaseYear) as releaseYear, toFloat(row.avgVote) as avgVote,
collect({id: row.personId, name:row.name, born: toInteger(row.birthYear), died:toInteger(row.deathYear),personType: row.personType, roles: split(coalesce(row.characters,""),':')}) as people
MERGE (m:Movie {id:movieId})
   ON CREATE SET m.title=title, m.avgVote=avgVote,
      m.releaseYear=releaseYear, m.genres=split(genres,":")
WITH *
UNWIND people as person
MERGE (p:Person {id: person.id})
   ON CREATE SET p.name = person.name, p.born = person.born, p.died = person.died
WITH  m, person, p
CALL apoc.do.when(person.personType = 'ACTOR',
     "MERGE (p)-[:ACTED_IN {roles: person.roles}]-&gt;(m)
                ON CREATE SET p:Actor",
     "MERGE (p)-[:DIRECTED]-&gt;(m)
         ON CREATE SET p:Director",
     {m:m, p:p, person:person}) YIELD value AS value
RETURN count()  // cannot end query with APOC call<!--/code--></pre>
</div>
</div>
<div class="paragraph">
<p>The results returned should look like this:</p>
</div>
<div class="imageblock thumb">
<div class="content">
<img src="https://guides.neo4j.com/advanced-cypher-exercises/img/EX6.8.png" alt="EX6.8" width="300">
</div>
</div>
<div class="paragraph">
<p>&#160;<br></p>
</div>
<div class="paragraph">
<p>This method of loading the data required 290,026 DB hits, which is better than the previous method. Collecting the results and unwinding them is much more efficient.</p>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6.9: Create the indexes. (Instructions)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p><strong>To improve retrieval performance, create indexes as follows, just as you did for the normalized data:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Index on the <code>name</code> property of a <code>Person</code> node.</strong></p>
</li>
<li>
<p><strong>Index on the <code>title</code> property of a <code>Movie</code> node.</strong></p>
</li>
</ul>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6.9: Create the indexes and constraints. (Solution)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p><strong>To improve retrieval performance, create indexes as follows, just as you did for the normalized data:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Index on the <code>name</code> property of a <code>Person</code> node.</strong></p>
</li>
<li>
<p><strong>Index on the <code>title</code> property of a <code>Movie</code> node.</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is the solution code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable programlisting cm-s-neo code runnable standalone-example ng-binding" data-lang="cypher" lang="cypher"><!--code class="cypher language-cypher"-->CREATE INDEX ON :Person(name);

CREATE INDEX ON :Movie(title)<!--/code--></pre>
</div>
</div>
<div class="paragraph">
<p>The results returned should look like this:</p>
</div>
<div class="imageblock thumb">
<div class="content">
<img src="https://guides.neo4j.com/advanced-cypher-exercises/img/EX6.9.png" alt="EX6.9" width="300">
</div>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6.10: Create the <code>Genre</code> nodes and <code>:IS_GENRE</code> relationships. (Instructions)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p><strong>Just as you did for the load of the normalized data,  create a uniqueness constraint for the <code>name</code> property for nodes of type <code>Genre</code>.
Then use the data in the graph to create <code>Genre</code> nodes from the <code>Movie</code> nodes and add the <code>:IS_GENRE</code> relationships between <code>Movie</code> nodes and <code>Genre</code> nodes.
In addition, remove the <code>genres</code> property from the <code>Movie</code>  nodes.</strong></p>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6.10: Create the <code>Genre</code> nodes and <code>:IS_GENRE</code> relationships. (Solution)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p><strong>Just as you did for the load of the normalized data,  create a uniqueness constraint for the <code>name</code> property for nodes of type <code>Genre</code>.
Then use the data in the graph to create <code>Genre</code> nodes from the <code>Movie</code> nodes and add the <code>:IS_GENRE</code> relationships between <code>Movie</code> nodes and <code>Genre</code> nodes.
In addition, remove the <code>genres</code> property from the <code>Movie</code>  nodes.</strong></p>
</div>
<div class="paragraph">
<p>Here is the solution code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre mode="cypher"  class="highlight pre-scrollable programlisting cm-s-neo code runnable standalone-example ng-binding" data-lang="cypher" lang="cypher"><!--code class="cypher language-cypher"-->CREATE CONSTRAINT ON (g:Genre) ASSERT g.name IS UNIQUE;
MATCH (m:Movie)
UNWIND m.genres as name
WITH DISTINCT name, m
SET m.genres = null
MERGE (g:Genre {name:name})
WITH g, m
MERGE (g)&lt;-[:IS_GENRE]-(m)<!--/code--></pre>
</div>
</div>
<div class="paragraph">
<p>The results returned should look like this:</p>
</div>
<div class="imageblock thumb">
<div class="content">
<img src="https://guides.neo4j.com/advanced-cypher-exercises/img/EX6.10.png" alt="EX6.10" width="300">
</div>
</div>
<div class="paragraph">
<p>Your database should now be as follows:</p>
</div>
<div class="imageblock thumb">
<div class="content">
<img src="https://guides.neo4j.com/advanced-cypher-exercises/img/EX6.10B.png" alt="EX6.10B" width="300">
</div>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6: Taking it further</h3>
    <br/>
    <div>
      <div class="paragraph">
<p>Perform some queries to become familiar with the newly-loaded data.</p>
</div>
	</div>
  </div>
</slide>



<slide class="row-fluid">
  <div class="col-sm-12">
    <h3>Exercise 6: Loading denormalized data   (Summary)</h3>
    <br/>
    <div>
      <div class="paragraph">
<p>In this exercise, you have written code to load denormalized data into a graph and also create nodes from data in the graph. You have seen that one way that you can optimize the load is to save the data during one pass into a collection and unwind the data for processing.</p>
</div>
<div class="paragraph">
<p><a play-topic='https://guides.neo4j.com/advanced-cypher-exercises/07.html'>Continue to Exercise 7</a></p>
</div>
	</div>
  </div>
</slide>
  </carousel>
</article>