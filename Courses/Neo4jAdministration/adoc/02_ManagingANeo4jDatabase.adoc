
= Managing a Neo4j Database
:presenter: Neo Technology
:twitter: neo4j
:email: info@neotechnology.com
:neo4j-version: 3.5
:currentyear: 2018
:doctype: book
:toc: left
:toclevels: 3
:experimental:
//:imagedir: https://s3-us-west-1.amazonaws.com/data.neo4j.com/neo4j-admin/img
:imagedir: ../img


++++
	<script type='text/javascript'>
	var loc = window.location;
	if (loc.hostname == "neo4j.com" && loc.search.indexOf("aliId=") == -1 ) {
	 loc.pathname = "/graphacademy/online-training/XXXX/"	
	}
	document.write(unescape("%3Cscript src='//munchkin.marketo.net/munchkin.js' type='text/javascript'%3E%3C/script%3E"));
	</script>
	<script>Munchkin.init('773-GON-065');</script>
++++

== About this module

Now that you have installed the Neo4j Enterprise Edition, you will learn how to perform some administrative tasks (on Debian) with the Neo4j instance.

At the end of this module, you should be able to:
[square]
* Set the password for the _neo4j_ user.
* Start a Neo4j instance.
* Stop the Neo4j instance.
* Copy a Neo4j database.
* Modify the location for a Neo4j database.
* Check the consistency of a Neo4j database.
* Create scripts for modifying a Neo4j database.
* Manage plugins for a Neo4j database.
* Configure ports used by the Neo4j instance.

== Neo4j instance files

Depending on your platform, a Neo4j instance's files are, by default, placed as described https://neo4j.com/docs/operations-manual/3.5/configuration/file-locations/[here]. 

[cols="20,80", options="header",stripes="none"]
|====
 *Purpose of folder*
|*Description*
| 
{set:cellbgcolor:white}
Tools
|The  */usr/bin* folder contains the tooling scripts you will typically run to manage the Neo4j instance. 
|Configuration
|*Neo4j.conf* is the primary configuration file for the Neo4j instance and resides in the */etc/neo4j* folder. 
|Logging
|The */var/log/neo4j folder contains log files that you can monitor.
|Database(s)
|The */var/lib/neo4j/data* folder contains the database(s).
|====
{set:cellbgcolor!}

== Post-installation preparation

When Neo4j is installed on Debian, the neo4j service is enabled and the Neo4j instance is automatically started. 
When you are setting up the production environment, you want to control when the Neo4j instance starts as you will performing some configuration changes and database operations may require that the instance to be stopped.

Initially, you should disable neo4j as a service that is started automatically when the system starts. You do this with this command:

`sudo systemctrl disable neo4j`

== Managing the Neo4j instance

When the instance is started, it creates a database named *graph.db* in the default location which is a folder under */var/lib/neo4j/data/databases*. You can start and stop the instance regardless of whether the neo4j service is enabled.

You start, stop, and restart the Neo4j instance as follows:

`sudo systemctl start neo4j`
`sudo systemctl stop neo4j`
`sudo systemctl restart neo4j`

When the Neo4j instance starts, it opens the database, and writes to the folders for the database and to the log file.

=== Checking the status of the instance

At any time, you can check the status of the Neo4j instance.

You check the status of the instance as follows:

`systemctl status neo4j`

Here is an example where we check the status of the Neo4j instance:

image::{imagedir}/Neo4jStatus-Debian.png[Neo4jStatus-Debian,width=800,align=center]

Here we see that the instance is started. Notice that the service is disabled as well.
After the instance is started you can identify the process ID (Main PID) from the status command on Debian. It is sometimes helpful to know the process ID of the Neo4j instance (JVM) in the event that it is unresponsive and you must kill it.

=== Viewing the neo4j log

The status command gives you a short glimpse of the status of the Neo4j instance. In some cases, although the instance is _active_, it may not have started successfully. You may want to examine more information about the instance, such as the folders it is using at runtime and information about activity against the instance, and especially if any errors occurred during startup. As an administrator, you should become familiar with the types of records that are written to the log file(s) for the Neo4j instance. 

You can view the log file for the instance on Debian as follows:

`journalctl -u neo4j`  to view the entire neo4j log file
`journalctl -e -u neo4j` to view the end of the neo4j log file

Here is the result from journalctl:

image::{imagedir}/FirstNeo4jLog-Debian.png[FirstNeo4jLog-Debian,width=800,align=center]

When the Neo4j instance starts, you can also confirm that it is started by seeing the _Started_ record in the log file.

=== *Exercise #1: Managing the Neo4j instance*

In this Exercise, you will stop and start the Neo4j instance and view its status and log file.

*Before you begin*

You should disable the neo4j service `sudo systemctrl disable neo4j`.

*Exercise steps*:

. Open a terminal on your system.
. View the status of the Neo4j instance.
. Stop the Neo4j instance.
. View the status of the Neoj instance.
. Examine the Neo4j log file.
. Examine the files and folders created for this Neo4j instance.

== Using `cypher-shell`

`cypher-shell` enables you to access the Neo4j database from a terminal window.  You simply log into the database using `cypher-shell` with your credentials:

`/usr/bin/cypher-shell -u neo4j -p neo4j`

Once authenticated, you enter Cypher statements to execute just as they would in Neo4j Browser. One caveat with `cypher-shell`, however is that all Cypher commands [.underline]#must# end with `;`. You exit `cypher-shell` with the command `:exit`.

Here is an example showing that we can successfully log in to the database for the Neo4j instance, provide the default credentials _neo4j/neo4j_:

image::{imagedir}/InitialCypherShellLogin-Debian.png[InitialCypherShellLogin-Debian,width=800,align=center]

=== Changing the default password

If we were to attempt to access the database for the first time, we would receive an error. This is because the default credentials neo4j/neo4j [underline]#must# be changed. As an administrator, you want to control who can manage this Neo4j instance and its database. To do so, you change the default password for the _neo4j_ user. Later in this training, you will learn more about securing Neo4j. 

While logged into the database in `cypher-shell`, you execute the procedure to change the password:

`CALL dbms.changePassword('newPassword');

In this example, we log into `cypher-shell` with our credentials. Then we execute the Cypher command to change the password. Finally, we specify `:exit` to log out of `cypher-shell`.

image::{imagedir}/ChangePassword-Debian.png[ChangePassword-Debian,width=1000,align=center]

After changing the default password for the Neo4j instance (database), we are now able to access the database after logging in with the new credentials. 

=== Accessing the database

Here is an example where we execute a Cypher statement against the empty database where we list all active queries:

image::{imagedir}/CypherShellStatement-Debian.png[CypherShellStatement-Debian,width=1000,align=center]

When you are done with `cypher-shell`, you enter `:exit` to exit.

=== *Exercise #2: Using `cypher-shell` to change the password*

In this Exercise, you will log in to the database with `cypher-shell`, change the password for the database, and execute a Cypher statement to load the database.

*Before you begin*

You should ensure that the Neo4j instance is started.

*Exercise steps*:

. Open a terminal on your system.
. Log into the database with `cypher-shell` using the default credentials of _neo4j/neo4j_.
. Execute the Cypher statement, `CALL dbms.listQueries();`. Do you get an error?
. Execute the Cypher statement to change the password to something you will remember.
. Exit out of `cypher-shell`.
. Log into the database with `cypher-shell` using the new credentials.
. Execute the Cypher statement, `CALL dbms.listQueries();`.
. Open this Cypher https://s3-us-west-1.amazonaws.com/data.neo4j.com/admin-neo4j/movieDB.cypher[file]. This file contains the Cypher statements to load the database with movie data. Copy the contents of this file onto your clipboard.
. Paste the contents of the file into your `cypher-shell` session and press the `ENTER` key to execute the statements. You should see something like the following:

image::{imagedir}/Ex2-LoadMovieDB-cypher-shell.png[Ex2-LoadMovieDB-cypher-shell,width=1000,align=center]

[start=10]
. The database is now populated with the _Movie_ data. Execute a Cypher statement to retrieve data from the database, for example: `MATCH (p:Person) WHERE p.name="Tom Cruise" RETURN p.name, p.born;` You should see the following:

image::{imagedir}/Ex2-RetrieveData.png[Ex2-RetrieveData,width=1000,align=center]

[start=11]
. Exit `cypher-shell`.

== Renaming a Neo4j database

By default, the Neo4j database is located in the */var/lib/neo4j/data/databases* folder. The database is represented by a subfolder with the default name, *graph.db*. You should never modify, copy, or move any files or folders under *graph.db*.

A key file for a Neo4j instance is */etc/neo4j/neo4j.conf*. This file contains all settings used by the Neo4j instance at runtime. Here is a portion of the default *neo4j.conf* file that is installed with Neo4j. The setting for the name of the database is the property _dbms.active_database_, which, by default, is *graph.db* Since this is the default configuration as installed, this setting is commented out in the configuration file because Neo4j assumes that the default will be used a runtime.

image::{imagedir}/DefaultNeo4jConfig.png[DefaultNeo4jConfig,width=800,align=center]

If you wanted to change the name of the Neo4j database, you could change the folder name *graph.db* to another name, but if you do so, you must uncomment the line in *neo4j.conf* for _dbms.active_database_ to match what you have renamed the database folder to. You must make this type of change in the configuration when the Neo4j instance is stopped.

== Deleting a Neo4j database

You would want to delete a Neo4j database for a couple of reasons:

[square]
* The database is no longer needed or usable and you want to recreate a fresh database.
* The database is no longer needed and you want to remove it so that a new database can be used. To do this you would load a new database which you will learn about next in this module.

To delete a Neo4j database you must:

. Stop the Neo4j instance.
. Remove the folder for the active database.
.. . For example, delete the *graph.db* database: `rm -rf /var/lib/neo4j/data/databases/graph.db`

If you were to start the Neo4j instance, it would recreate an empty database. If you want to copy an existing database for use with this Neo4j instance, you dump and load an existing database to be used as the active database. Then you can start the Neo4j instance. You will learn about dumping an loading a database next.

== Copying a database

The structure of a Neo4j database is proprietary and could change from one release to another. You should [underline]#never# copy the database from one location in the filesystem/network to another location.

To copy a database that, perhaps you want to have as an additional copy or you want to give  to another user for use on their system, you must:

. Stop the Neo4j instance.
. Ensure that the folder where you will dump the database exists.
. Use the *dump* command of the `neo4j-admin` tool to create the dump file.

Then, if you want to create a database from the dump file to use in a Neo4j instance, you must:

. Stop the Neo4j instance.
. Determine what you will call the new database and adjust *neo4j.conf* to use this database as the active database.
. Use the *load* command of the `neo4j-admin` tool to create the database from the dump file using the same name you specify in the *neo4j.conf* file.
. Start the Neo4j instance.

=== Dumping a database

To dump a database, the Neo4j instance must be stopped.
Here is how to use the *dump* command of the  `neo4j-admin` tool to dump a database to a file:

`neo4j-admin dump --database=db-folder --to=db-target-folder/db-dump-file`

_where:_

{set:cellbgcolor:white}
[frame="none",,width="80%"cols="20,80",stripes=none]
|===
|_db-folder_
|is the name of the folder representing source database to be dumped.
|_db-target-folder_
|is the folder in the filesystem where you want to place the dumped database. This folder must exist.
|_db-dump-file_
|is the name of the dump file that will be created.
|===
{set:cellbgcolor!}

Here is an example where we have previously renamed the database to be _movie.db_ and we have created a folder named _dumps_. We dump the _movie.db_ using `neo4j-admin`:

image::{imagedir}/DumpDatabase.png[DumpDatabase,width=1000,align=center]

After the dump file, _movie-dump_ is created, you can move it anywhere on filesystem or network.

=== Loading a database

Assuming that you have a dump file to use, you must first determine what the name of the target database will be. If you use an existing database name, the load command, can overwrite the database. If you want to create a new database, then you specify a database name that does not already exist. To perform the load command, the Neo4j instance must be stopped. In addition, the user:group permissions of the files created must be neo4j:neo4j. 

[NOTE]
You must either perform the load operation as the neo4j user, or after the load, you must change the owner of all files and folders created to neo4j:neo4j.

Here is how to use the *load* command of the  `neo4j-admin` tool to load a database from a file:

`neo4j-admin load --from=path/db-dump-file --database=db-folder [--force=true]`
_where:_

{set:cellbgcolor:white}
[frame="none",,width="80%"cols="20,80",stripes=none]
|===
|_path_
|is a folder in the filesystem where the dump file resides.
|_db-dump-file_
|is the file previously created with the *dump* command of `neo4j-admin`.
|_db-folder_
|is the name of the database that will be created or overwritten if --force is specified as `true`.
|===
{set:cellbgcolor!}

Here is an example where we load the contents of *movie-dump* into a database named *movie2.db*. 

image::{imagedir}/LoadDatabase.png[LoadDatabase,width=1000,align=center]

In order to access this newly created and loaded database, we must modify *neo4j.conf* to use *movie2.db* as the active database before starting the Neo4j instance:

image::{imagedir}/Movie2ActiveDatabase.png[Movie2ActiveDatabase,width=1000,align=center]

A best practice is to examine the log file for the Neo4j instance after you have made any configuration changes.

=== *Exercise #3: Copying a database*

In this Exercise, you will make a copy of your active database that has the movie data in it and use the dump file to create a database.

*Before you begin*

You should have loaded the *graph.db* database with the movie data (Exercise #2) and stopped the Neo4j instance.

*Exercise steps*:

. Open a terminal on your system.
. Create a folder named /usr/local/work*.
. Use the `neo4j-admin` script to dump the *graph.db* database to the *work* folder. You should do something like this:

image::{imagedir}/Ex3-movie-dump.png[Ex3-movie-dump,width=1000,align=center]

[start=4]
. Notice that this dump file is simply a file that can be copied to any location.
. Delete the *graph.db* database.
. Use the `neo4j-admin` script to load the database from the dump file you just created. Name the database *movie.db*. Note that you should perform the load as the _neo4j_ user. If you do not have the credentials to log in as the _neo4j_ users, then you can change the owner of the files later. You should do something like this:

image::{imagedir}/Ex3-movie-load.png[Ex3-movie-load,width=1000,align=center]

[start=7]
. Modify *neo4j.conf* to use *movie.db* as the active database.

image::{imagedir}/Ex3-movie-cfg.png[x3-movie-cfg,width=1000,align=center]

[start=8]
. If you did not perform the load as the user _neo4j_, you must change the owner:group of all files and folders under *movie.db* to be _neo4j:neo4j_. For example, change directory to the *movie.db* folder and  then enter the command: 
       `sudo chown -R neo4j:neo4j *`.  
	   This will recursively change the owner and group to all files and folders under *movie.db*.

. Start the Neo4j instance.
. Examine the log file to ensure that the instance started with no errors.
. Access the database using `cypher-shell`. Can you see the movie data in the database?

image::{imagedir}/Ex3-AccessDB.png[Ex3-AccessDB,width=800,align=center]

== Modifying the location of the database

If you do not want the database used by the Neo4j instance to reside in the same location as the Neo4j installation, you can modify its location in the *neo4j.conf* file. If you specify a new location for the data, it must exist in the filesystem and the folder must be owned by _neo4j:neo4j_.

Here we have specified a new location for the data in the configuration file:

image::{imagedir}/ModifyDataLocation.png[ModifyDataLocation,width=800,align=center]

We ensure that the location for the data exists and then we can start the Neo4j instance. If this is the first time Neo4j has been started for this location, a new database named *graph.db* will be created. This is because we are using the default database name in the configuration file.

image::{imagedir}/UsingNewDataLocation.png[UsingNewDataLocation,width=800,align=center]

If you have an existing database that you want to reside in a different location for the Neo4j instance, remember that you must dump and load the database to safely copy it to the new location.

=== Using a name other than graph.db

If you are starting the Neo4j instance with a new location and you are not using the default *graph.db* database name, you must follow these steps to ensure that the folders for the database are set up properly:

. Specify the new location in the configuration file, but do not specify the active database name.
. Start or restart the Neo4j instance. A new *graph.db* folder will be created as well as the other folders required by the instance.
. Examine the log file to ensure that it started without errors.
. Stop the Neo4j instance.
. Specify the name of the active database in the configuration file.
. Load the data into the database name that will be the active database. 
. If you did not load the database the the user _neo4j_, recursively change the owner:group to _neo4j:neo4j_.
. Start the Neo4j instance.
. Examine the log file to ensure it started without errors.

=== *Exercise #4: Modifying the location of the database*

In this Exercise, you will set up a different location for the database in your local filesystem and start the Neo4j instance using the database from this new location.

*Before you begin*

. You should have created the dump file for the movie database (Exercise #3).
. Stop the Neo4j instance.

*Exercise steps*:

. Open a terminal on your system.
. Create a folder named */usr/local/data*. This is the folder where the database will reside which is different from the default location used by Neo4j. 
. Make sure that this *data* folder is owned by _neo4j:neo4j_. For example, navigate to the */usr/local* folder and enter `sudo chown neo4j:neo4j data`. 
. Modify the *neo4j.conf* file to use */usr/local/data* as the data directory. Also ensure that there is no active database specified. Your *neo4j.conf* file should look something like this:

image::{imagedir}/Ex4-LocationConfig.png[Ex4-LocationConfig,width=800,align=center]

[start=5]
. Start the Neo4j instance.
. Examine the log file to ensure that the instance started without errors.
. Examine the files in the */usr/local/data* location. The instance should have created the *databases* and *dbms* folders. They should look as follows:

image::{imagedir}/Ex4-LocationInUse.png[Ex4-LocationInUse,width=800,align=center]

[start=8]
. Stop the Neo4j instance.
. Modify the *neo4j.conf* file to use *movie3.db* as the active database. Your *neo4j.conf* file should look something like this:

image::{imagedir}/Ex4-ActiveDatabase.png[Ex4-ActiveDatabase,width=800,align=center]

[start=10]
. Use the `neo4j-admin` script to load the database from the dump file you created in Exercise 3. Name the database *movie3.db* You should do something like this:

image::{imagedir}/Ex4-LoadDB.png[Ex4-LoadDB,width=800,align=center]

[start=11]
. If you did not perform the load as the user _neo4j_, you must change the owner:group of all files and folders under *movie3.db* to be _neo4j:neo4j_. For example, change directory to the *databases* folder and  then enter the command: 
       `sudo chown -R neo4j:neo4j movie3.db`.  
	   This will recursively change the owner and group to all files and folders under *movie3.db*.
. Start the Neo4j instance.
. Examine the log file to ensure that no errors occurred.
. Access the database using `cypher-shell`. Do you get an authentication error?  This is because the database is now located in a different location and the default credentials of neo4j/neo4j are used.

image::{imagedir}/Ex4-Access.png[Ex4-Access,width=1000,align=center]

[start=15]
. Enter the Cypher statement to change the password: `CALL dbms.changePassword('newPassword');`
. Enter a Cypher statement to retrieve some data: `MATCH (p:Person) WHERE p.name="Meg Ryan" RETURN p.name, p.born;`
. Exit `cypher-shell`.

image::{imagedir}/Ex4-Access2.png[Ex4-Access2,width=1000,align=center]

== Checking the consistency of a database

A database's consistency could be compromised if a software or hardware failure has occurred that affects the Neo4j instance. You will learn later in this training about live backups and replicating databases, but if you have reason to believe that a specific database has been corrupted,  you can perform a consistency check on it.

The Neo4j instance must be stopped to perform the consistency check.

Here is how you use the `neo4j-admin` tool to check the consistency of the database:

`neo4j-admin check-consistency --database=db-name --report-dir=report-location [--verbose=true]`

The database named _db-name_ is found in the data location specified in *neo4j.conf* file. If the tool comes back with no error, then the database is consistent. Otherwise, an error is returned and a report is written to _report-location_. You can specify verbose reporting. See the _Operations Manual_ for more options. For example, you can check the consistency of a backup. 

Suppose we had loaded the *movie4.db* database with `neo4j-admin`. Here is what a successful run of the consistency checker should produce:

image::{imagedir}/ConsistentPassed.png[ConsistentPassed,width=1000,align=center]

No report is written to the reports folder because the consistency check passed.

Here is an example of what an unsuccessful run of the consistency checker should produce:

image::{imagedir}/Inconsistencies.png[Inconsistencies,width=1000,align=center]

If inconsistencies are found, a report is generated and placed in the folder specified for the report location.

Inconsistencies in a database are a serious matter that should be looked into with the help of Neo4j Technical Support. Later in this training you will learn more about troubleshooting problems that are detected.

=== *Exercise #5: Checking consistency of a database*

In this Exercise, you check the consistency of a database that is consistent. Then you modify a file that causes the database to become inconsistent and then check its consistency.

*Before you begin*

. You should have created and started the *movie3.db* database (Exercise #6).
. Stop the Neo4j instance.
. Create a folder named */usr/local/work/reports*.

*Exercise steps*:

. Open a terminal on your system.
. Run the consistency check tool on *movie3.db* using neo4j-admin specifying *reports* as the folder where the report will be written. The admin-tool should return the following:

image::{imagedir}/Ex5-Consistent.png[Ex5-Consistent,width=1000,align=center]

[start=3]
. Modify the neo4j configuration to use a database named *movie3-copy.db*, rather than *movie3.db*.
. Use `neo4j-admin` to create and load *movie3-copy.db* from the movie dump file you created earlier.
. Ensure that the owner of the *movie3-copy.db* is _neo4j:neo4j_.
. Next, you will corrupt the database. Modify the file *movie3-copy.db/neostore.nodestore.db* by adding some text to the file.
. Run the consistency check tool on *movie3-copy.db* using neo4j-admin specifying */usr/local/work/reports* as the folder where the report will be written. The admin-tool should return something like the following:

image::{imagedir}/Ex5-Inconsistent.png[Ex5-Inconsistent,width=1000,align=center]

== Scripting with cypher-shell

As a database administrator, you may need to automate changes to the database. The most common types of changes that administrators may want to perform are operations such as adding/dropping constraints or indexes. You can create scripts that forward the Cypher statements to `cypher-shell`.  The number of supporting script files you create will depend upon the tasks you want to perform against the database.

Suppose that we use _bash_. We create 3 files:

*1. AddConstraints.cypher* that contains the Cypher statements to execute in `cypher-shell`:
----
CREATE CONSTRAINT ON (m:Movie) ASSERT m.title IS UNIQUE; 
CREATE CONSTRAINT ON (p:Person) ASSERT p.name IS UNIQUE;
----

Each Cypher statement must end with a `;`. 

*2. DropConstraints.sh* that invokes `cypher-shell` using a set of Cypher statements and appends its output to the log file:
----
cat /usr/local/work/AddConstraints.cypher | /usr/bin/cypher-shell -u neo4j -p training-helps --format verbose 2>&1 >> /usr/local/work/PrepareDB.log
----

*3. PrepareDB.sh* that initializes the log file, *PrepareDB.log*, and calls the script to add the constraints:
----
rm -rf /usr/local/work/PrepareDB.log
/usr/local/work/AddConstraints.sh 2>&1 >> /usr/local/work/PrepareDB.log
----

When the *PrepareDB.sh* script runs its scripts, all output will be written to the log file, including error output. Then you can simply check the log file to make sure it ran as expected.


===  *Exercise #6: Scripting changes to the database*

In this Exercise, you will gain experience scripting with Cypher shell. You will create three files in the */usr/local/work* folder:

. *AddConstraints.cypher*
. *AddConstraints.sh*
. *MaintainDB.sh*

*Before you begin*

. Remove the *~/databases/movie3-copy.db* folder as this database is now corrupt.
. Ensure that the Neo4j configuration uses *movie3.db* for the database.
. Start the Neo4j instance.

*Exercise steps*:

. Open a terminal on your system.
. Start Cypher-shell, providing the credentials for the neo4j user.

image::{imagedir}/Ex6-StartCypher-shell.png[Ex6-StartCypher-shell,width=800,align=center]

[start=3]
. Enter some simple Cypher statements to confirm that you can access the database. For example:
.. `CALL db.schema();`
.. `CALL db.constraints();`
. Exit Cypher-shell by typing `:exit`.
. Create a Cypher script in the */usr/local/work* folder named *AddConstraints.cypher* with the following statements:
----
CREATE CONSTRAINT ON (m:Movie) ASSERT m.title IS UNIQUE; 
CREATE CONSTRAINT ON (p:Person) ASSERT p.name IS UNIQUE; 
----

[start=6]
. Create a shell script in the */usr/local/work* folder named *AddConstraints.sh* that will forward *AddConstraints.cypher* to cypher-shell. This file should have the following contents:

----
cat /usr/local/work/AddConstraints.cypher | /usr/bin/cypher-shell -u neo4j -p training-helps --format verbose 2>&1 >> /usr/local/work/MaintainDB.log
----

[start=7]
. Create a shell script in the */usr/local/work* folder named *MaintainDB.sh* that will initialize the log file and then call *AddConstraints.sh*. This file should have the following contents:

----
rm -rf /usr/local/work/MaintainDB.log
/usr/local/work/AddConstraints.sh 2>&1 >> /usr/local/work/MaintainDB.log
----

[start=8]
. Ensure that the scripts you created have execute permissions.
. Run the *MaintainDB.sh* script and  view the log file.

image::{imagedir}/Ex6-RunMaintainDB.png[Ex6-RunMaintainDB,width=800,align=center]

[start=10]
. Confirm that it created the constraints in the database. (Check using cypher-shell (`CALL db.constraints();`))

image::{imagedir}/Ex6-ConfirmConstraints.png[Ex6-ConfirmConstraints,width=800,align=center]

== Managing plugins required for the database

Some applications can use Neo4j out-of-the-box, but many applications require additional functionality that could be:

[square]
* A library supported by Neo4j such as GraphQL or GRAPH ALGORITHMS.
* A community-supported library, such as APOC.
* Custom functionality that has been written by the developers of your application. 

We refer to this additional functionality as a _plugin_ that contains specific procedures. First, you should understand how to view the procedures available for use with the Neo4j instance. You do so by executing the Cypher statement `CALL db.procedures()`.

Here is an example of a script you can run to produce a file, *Procedures.txt* that contain the names of the procedures currently available for the Neo4j instance:

----
echo "CALL dbms.procedures() YIELD name;" | /usr/bin/cypher-shell -u neo4j -p training-helps --format plain > /usr/local/work/Procedures.txt
----

This script calls dbms.procedures to return the name of each procedure in the list returned. 

Here is a view of *Procedures.txt*:

image::{imagedir}/DefaultProcedures.png[DefaultProcedures,width=400,align=center]

By default, the procedures available to the Neo4j instance are the built-in procedures that are named _db.*_ and _dbms.*_.

=== Adding a plugin to the Neo4j instance

To add a plugin to your Neo4j instance, you must first obtain the *.jar* file. It is important to confirm that the *.jar* file you will use is compatible with the version of Neo4j that you are using. For example, a plugin released for release 3.4 of Neo4j can be used by a Neo4j 3.5 instance, but the converse *may* not be true. You must check with the developers of the plugin for compatibility.

Some plugins require a configuration change. You should understand the configuration changes required for any plugin you are installing.

Neo4j provides _sandboxing_ to ensure that procedures do not inadvertently use insecure APIs. For example, when writing custom code it is possible to access Neo4j APIs that are not publicly supported, and these internal APIs are subject to change, without notice. 
Additionally, their use comes with the risk of performing insecure actions. The sandboxing
functionality limits the use of extensions to publicly supported APIs, which exclusively contain safe operations,
or contain security checks.

Neo4j _White listing_ can be used to allow loading only a few extensions from a larger library.
The configuration setting _dbms.security.procedures.whitelist_ is used to name certain procedures that should be
available from a library. It defines a comma-separated list of procedures that are to be loaded.
The list may contain both fully-qualified procedure names, and partial names with the wildcard *.

=== Installing the Graph Algorithms plugin

Suppose we wanted to install the Graph Algorithms library that is compatible with Neo4j 3.5. We find the library in GitHub and simply download the *.jar* file. Here is the https://github.com/neo4j-contrib/neo4j-graph-algorithms/releases[release area] in GitHub for the graph algorithms library:

image::{imagedir}/GitHubGraphAlgos.png[GitHubGraphAlgos,width=800,align=center]

The main page for https://github.com/neo4j-contrib/neo4j-graph-algorithms[Graph Algorithms] in GitHub contains details about the plugin and instructions for installing it.

You download any plugins that your application will use to the /var/lib/neo4j/plugins folder:

image::{imagedir}/GraphAlgos.png[GraphAlgos,width=800,align=center]

Ensure that the *.jar* file is owned by _neo4j:neo4j_ and that it has execute permissions.

The graph algorithms plugin requires _sandboxing_.
Here is how we enable the procedures in the graph algorithms plugin. We modify the _Miscellaneous Configuration_ section of the *neo4j.conf* file as follows:

image::{imagedir}/ConfigGraphAlgos.png[ConfigGraphAlgos,width=800,align=center]

You must then start or restart the Neo4j instance. Once started, you can then run the script to return the names of the procedures that are available to the Neo4j instance. Here we see that we have the additional procedures for the graph algorithms plugin:

image::{imagedir}/GraphAlgosInstalled.png[GraphAlgosInstalled,width=600,align=center]

=== Installing the APOC plugin

https://github.com/neo4j-contrib/neo4j-apoc-procedures[APOC] (Awesome Procedures on Cypher) is a very popular plugin used by many applications. It contains over 450 user-defined procedures that make accessing a graph incredibly efficient and much easier than writing your own Cypher statements to do the same thing.

You obtain the plugin from the APOC https://github.com/neo4j-contrib/neo4j-apoc-procedures/releases[releases] page:

image::{imagedir}/APOCDownloadPage.png[APOCDownloadPage,width=800,align=center]

Here we download the *.jar* file, change its permissions to execute, and change the owner to be _neo4j:neo4j_.

image::{imagedir}/APOC.png[APOC,width=800,align=center]

After you have placed the *.jar* file into the *plugins* folder, you must modify the configuration for the instance as described in the main page for APOC. As described on this page, you have an option of either _sandboxing_ or _whitelisting_ the procedures of the plugin. How much of the APOC library is used by your application is determined by the developers so you should use them as a resource for this type of configuration change. 

Suppose we want to allow [.underline]#all# APOC procedures to be available to this Neo4j instance. We would sandbox the plugin in the *neo4j.conf* file as follows, similar to how we sandboxed the graph algorithms:

image::{imagedir}/APOCConfig.png[APOCConfig,width=800,align=center]

Since APOC is large, you will most likely want to whitebox specific procedures so that only the procedures needed by the application are loaded into the Neo4j instance at runtime.

And here we see the results after restarting the Neo4j instance and running the script to list the procedures loaded in the instance:

image::{imagedir}/APOCLoaded.png[APOCLoaded,width=400,align=center]

===  *Exercise #7: Install a plugin*

In this Exercise, you will install the Spatial library for use by your Neo4j instance and you will create and execute a script to report all of the procedures available to the Neo4j instance.

*Before you begin*:

. Stop the Neo4j instance.
. Make sure you have a terminal window open for executing test commands.

*Exercise steps*:

. In a Web browser, go to the GitHub repository for the https://github.com/neo4j-contrib/spatial[Neo4j Spacial Library].
. On the main page for this repository, find the latest release of the library that is compatible with your version of Neo4j Enterprise Edition.
. Download the already-built *.jar* file into the */var/lib/neo4j/plugins* folder.
. Ensure that the file size is correct and that the file name ends with *.jar*.
. Change the owner of the *.jar* file to _neo4j:neo4j_ and add execute permissions to the file.
. Restart the Neo4j instance.
. Follow the steps on the GitHub page for testing the library.

For example, you should see the following in the repository main page:

image::{imagedir}/Ex7-GetSpatialLibrary.png[Ex7-GetSpatialLibrary,width=800,align=center]

Here is how you download the *.jar* file into the */var/lib/neo4j/plugins* folder. You should confirm that the file size is correct and that the owner is _neo4j:neo4j_ with execute permissions.

image::{imagedir}/Ex7-SpatialLibrary.png[Ex7-SpatialLibrary,width=800,align=center]


Here is what you should see when you execute the first `curl` command:

image::{imagedir}/Ex7-SpatialQuery1.png[Ex7-SpatialQuery1,width=800,align=center]

Here is what you should see when you execute the second `curl` command:

image::{imagedir}/Ex7-SpatialQuery2.png[Ex7-SpatialQuery2,width=800,align=center]

[start=8]
. In the *NEO4J_HOME/work* folder, create a script named *ListProcedures.sh* that will write the list of procedures available to the Neo4j instance to the *$NEO4j/work/Procedures.txt* file.
. Run the ListProcedures.sh script and examine the contents to also verify that the plugin has been installed.

The *Procedures.txt* file should contain these items:

image::{imagedir}/Ex7-SpatialLibraryLoaded.png[Ex7-SpatialLibraryLoaded,width=800,align=center]


== Configuring connector ports for the Neo4j instance

The Neo4j instance uses https://neo4j.com/docs/operations-manual/current/configuration/ports/[default port numbers] that may conflict with other processes on your system. The ports used frequently are the connector ports:

[cols="10,10,80", options="header",stripes="none"]
|====
 *Name*
| *Port Number*
| *Description*
| 
{set:cellbgcolor:white}
 HTTP
| 7474
| Used by Neo4j Browser and REST API. It is *not* encrypted so it should never be exposed externally.
| HTTPS 
| 7473
| Used by REST API. Requires additional SSL configuration.
| Bolt
| 7687
| Bolt connection used by Neo4j Browser, cypher-shell
|====
{set:cellbgcolor!}

If any of these ports conflict with ports already used on your system, you can change these connector ports by modifying these property values in the *neo4j.conf* file:

----
# Bolt connector
dbms.connector.bolt.enabled=true
#dbms.connector.bolt.tls_level=OPTIONAL
#dbms.connector.bolt.listen_address=:*7687*

# HTTP Connector. There can be zero or one HTTP connectors.
dbms.connector.http.enabled=true
#dbms.connector.http.listen_address=:*7474*

# HTTPS Connector. There can be zero or one HTTPS connectors.
dbms.connector.https.enabled=true
#dbms.connector.https.listen_address=:*7473*
----

As you learn more about some of the other administrative tasks for a Neo4j instance, you will work with other ports.

[NOTE]
It is not possible to disable the HTTP connector. See the https://neo4j.com/docs/operations-manual/current/configuration/connectors/[connectors] section of the _Operations Manual_ for more information.

===  *Exercise #8: Modify the HTTP port*

In this Exercise, you will modify the default HTTP port used by the HTTP instance and use the new port.

*Exercise steps*:

. Change the HTTP port to a value that is not in use on your system, for example 9999.

For example, your *neo4j.conf* file should look something like this:

image::{imagedir}/Ex8-HTTP9999.png[Ex8-HTTP9999,width=800,align=center]

[start=2]
. Restart the Neo4j instance.
. Confirm that the port works by either going to localhost:9999 from a Web browser or using the previous `curl` command using the new port number.

image::{imagedir}/Ex8-HTTP9999-used.png[Ex8-HTTP9999-used,width=800,align=center]

[start=4]
. Change the HTTP port back to its default.
. Restart the Neo4j instance

== Check your understanding
=== Question 1

Suppose that you have installed Neo4j Enterprise Edition and have changed the password for the user, _neo4j_. What script and command do you run to create a Neo4j database for the instance?

Select the correct answer.
[%interactive]
- [ ] [.false-answer]#`neo4j-admin create-database`#
- [ ] [.false-answer]#`neo4j-admin initialize`#
- [ ] [.false-answer]#`neo4j create-database`#
- [ ] [.required-answer]#`neo4j start`#

=== Question 2

Suppose that you want the existing Neo4j database to have the name *ABCRecommendations.db*. Assuming that you have stopped the Neo4j instance, what steps must you perform to modify the name of the database, which currently has a default name of *graph.db*:

Select the correct answers.
[%interactive]
- [ ] [.required-answer]#Rename the *NEO4J_HOME/graph.db* folder to *NEO4J_HOME/ABCRecommendations.db*.#
- [ ] [.required-answer]#Modify *neo4j.conf* to use _dbms.active_database=ABCRecommendations.db_.#
- [ ] [.false-answer]#Run `neo4j-admin rename graph.db ABCRecommendations.db`.#
- [ ] [.false-answer]#Run `neo4j-admin move graph.db ABCRecommendations.db`.#

=== Question 3

How do you copy a database that you want to give to another user?

Select the correct answer.
[%interactive]
- [ ] [.false-answer]#With the Neo4j instance started, `run neo4j-admin copy` providing the location where the copy will be created.#
- [ ] [.false-answer]#With the Neo4j instance stopped, `run neo4j-admin copy` providing the location where the copy will be created.#
- [ ] [.false-answer]#With the Neo4j instance started, `run neo4j-admin dump` providing the location where the dump file will be created.#
- [ ] [.required-answer]#With the Neo4j instance stopped, `run neo4j-admin dump` providing the location where the dump file will be created.#

== Summary

You should now be able to:

[square]
* Set the password for the _neo4j_ user.
* Start a Neo4j instance.
* Stop the Neo4j instance.
* Copy a Neo4j database.
* Modify the location for a Neo4j database.
* Check the consistency of a Neo4j database.
* Create scripts for modifying a Neo4j database.
* Manage plugins for a Neo4j database.
* Configure ports used by the Neo4j instance.
