<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.7.1">
<title>Monitoring  Neo4j</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote::before{display:none}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{word-spacing:0;line-height:1.6}
.quoteblock.abstract blockquote::before,.quoteblock.abstract p::before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Monitoring  Neo4j</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_about_this_module">About this module</a></li>
<li><a href="#_what_can_be_monitored_and_measured_in_neo4j">What can be monitored and measured in Neo4j?</a></li>
<li><a href="#_monitoring_queries">Monitoring queries</a>
<ul class="sectlevel2">
<li><a href="#_configuring_query_logging">Configuring query logging</a></li>
<li><a href="#_viewing_currently_running_queries">Viewing currently running queries</a></li>
<li><a href="#_killing_a_long_running_query">Killing a long-running query</a></li>
<li><a href="#_exercise_1_monitoring_queries"><strong>Exercise #1: Monitoring queries</strong></a></li>
<li><a href="#_automating_monitoring_of_queries">Automating monitoring of queries</a></li>
</ul>
</li>
<li><a href="#_monitoring_transactions">Monitoring transactions</a>
<ul class="sectlevel2">
<li><a href="#_exercise_2_monitoring_transactions"><strong>Exercise #2: Monitoring transactions</strong></a></li>
<li><a href="#_monitoring_locks">Monitoring locks</a></li>
</ul>
</li>
<li><a href="#_monitoring_connections">Monitoring connections</a>
<ul class="sectlevel2">
<li><a href="#_exercise_3_monitoring_connections"><strong>Exercise #3: Monitoring connections</strong></a></li>
<li><a href="#_logging_http_requests">Logging HTTP requests</a></li>
<li><a href="#_exercise_4_monitoring_http_requests"><strong>Exercise #4: Monitoring HTTP requests</strong></a></li>
</ul>
</li>
<li><a href="#_monitoring_memory_usage">Monitoring memory usage</a>
<ul class="sectlevel2">
<li><a href="#_memory_consumption_of_a_neo4j_instance">Memory consumption of a Neo4j instance</a>
<ul class="sectlevel3">
<li><a href="#_initial_memory_settings_for_a_database">Initial memory settings for a database</a></li>
</ul>
</li>
<li><a href="#_monitoring_memory_consumption">Monitoring memory consumption</a></li>
<li><a href="#_exercise_5_monitoring_a_memory_issue"><strong>Exercise #5: Monitoring a memory issue</strong></a></li>
<li><a href="#_managing_log_files">Managing log files</a></li>
<li><a href="#_collecting_metrics">Collecting metrics</a>
<ul class="sectlevel3">
<li><a href="#_using_jmx_queries">Using JMX queries</a></li>
<li><a href="#_exercise_6_querying_with_jmx"><strong>Exercise #6: Querying with JMX</strong></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_check_your_understanding">Check your understanding</a>
<ul class="sectlevel2">
<li><a href="#_question_1">Question 1</a></li>
<li><a href="#_question_2">Question 2</a></li>
<li><a href="#_question_3">Question 3</a></li>
</ul>
</li>
<li><a href="#_summary">Summary</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
	<script type='text/javascript'>
	var loc = window.location;
	if (loc.hostname == "neo4j.com" && loc.search.indexOf("aliId=") == -1 ) {
	 loc.pathname = "/graphacademy/online-training/XXXX/"
	}
	document.write(unescape("%3Cscript src='//munchkin.marketo.net/munchkin.js' type='text/javascript'%3E%3C/script%3E"));
	</script>
	<script>Munchkin.init('773-GON-065');</script>
</div>
</div>
<div class="sect1">
<h2 id="_about_this_module">About this module</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that you have gained experience managing a Neo4j instance and database,  managing Neo4j Causal Clusters, and the steps you must take to secure your deployed Neo4j application, you will learn how to monitor the Neo4j instance as it is used by applications.</p>
</div>
<div class="paragraph">
<p>At the end of this module, you should be able to:</p>
</div>
<div class="ulist square">
<ul class="square">
<li>
<p>Describe the categories of monitoring and measurement you can perform with Neo4j.</p>
</li>
<li>
<p>Monitor:</p>
<div class="ulist">
<ul>
<li>
<p>queries</p>
</li>
<li>
<p>transactions</p>
</li>
<li>
<p>connections</p>
</li>
<li>
<p>memory usage</p>
</li>
</ul>
</div>
</li>
<li>
<p>Manage log files.</p>
</li>
<li>
<p>Manage the collection of Neo4j metrics.</p>
</li>
<li>
<p>Use JMX queries.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_can_be_monitored_and_measured_in_neo4j">What can be monitored and measured in Neo4j?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As an administrator, you should configure your deployed Neo4j application so that you can perform routine monitoring of activity, as well as being prepared to more deeply monitor and possibly re-configure Neo4j.</p>
</div>
<div class="paragraph">
<p>The Neo4j instance writes events to log files where you can configure the level of logging you want to perform. In addition, you can configure Neo4j to write  metrics to a directory that is dedicated for collecting runtime data. The <a href="https://neo4j.com/docs/operations-manual/3.5/configuration/file-locations/">Neo4j Operations Manual</a> describes these files and locations that you will be working with in this lesson.</p>
</div>
<div class="paragraph">
<p>You have already seen some of the events that are written to the <strong>neo4j.log</strong> file (journalctl -u neo4j on Debian)  when the Neo4j instance starts and you want to confirm that it started successfully. In addition, you have seen error events written to <strong>debug.log</strong> when attempting to start a Neo4j instance in a Causal Cluster. You have also seen authentication events that are written to the <strong>security.log</strong> file when users connect to the Neo4j instance.</p>
</div>
<div class="paragraph">
<p>In the previous lesson a about security, you learned about the authentication events that are written to the <strong>security.log</strong> file. The categories of events that you configure for and monitor in log files that you will learn about in this lesson include:</p>
</div>
<div class="ulist square">
<ul class="square">
<li>
<p>Queries</p>
</li>
<li>
<p>Transactions</p>
</li>
<li>
<p>Connections</p>
</li>
<li>
<p>Memory</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You have learned how to monitor core and read replica servers in a Neo4j Causal Cluster in the module, <em>Causal Clustering in Neo4j</em>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In addition, you can configure the Neo4j instance to collect metrics that are related to events, but can be viewed in tools (such as Grafana) that use the Graphite or Prometheus protocols to help you monitor your application. In most cases, you will want to configure a tool such as Nagios to provide alerts when certain metrics or events are detected in Neo4j. Note that you can also set up alerts in Grafana, but Nagios is a better choice for alerts. CloudWatch is another UI that is commonly use for monitoring and alerting with AWS deployments.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_monitoring_queries">Monitoring queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In a production environment, you want to know if a query is taking a long time and using too many resources. A user/application may not even be aware that their query is hung. For example, if they started a query and then walked away from their computer.</p>
</div>
<div class="paragraph">
<p>As an administrator, you can configure Neo4j to write information about queries that completed to the <strong>query.log</strong> file. You can provide settings that will log information about queries that took a long time to complete. You can also monitor currently running queries and if need be, kill them if they are taking too long.</p>
</div>
<div class="sect2">
<h3 id="_configuring_query_logging">Configuring query logging</h3>
<div class="paragraph">
<p>You can configure Neo4j to log an event if a query runs more than xx milliseconds. There is no standard for what a reasonable period of time is for a query, but in most databases, a query that runs for minutes is not a good thing! At a minimum, you should enable logging for queries and set a threshold for the length of time queries take. Then, as part of your monitoring, you could regularly inspect the <strong>query.log</strong> file to determine if a certain set of queries or users are possibly performing queries that tax the resources of the Neo4j instance.</p>
</div>
<div class="paragraph">
<p>For example, here are the properties you would set in the Neo4j configuration to log a message and provide information when a query takes more than 1000ms to complete:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>dbms.logs.query.enabled=true
dbms.logs.query.threshold=1000ms
dbms.logs.query.parameter_logging_enabled=true
dbms.logs.query.time_logging_enabled=true
dbms.logs.query.allocation_logging_enabled=true
dbms.logs.query.page_logging_enabled=true
dbms.track_query_cpu_time=true
dbms.track_query_allocation=true</pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="https://neo4j.com/docs/operations-manual/3.5/monitoring/logging/query-logging/">Neo4j Operations Manual</a> has a section on the configuration settings you can specify to log query events to the <strong>query.log</strong> file.</p>
</div>
</div>
<div class="sect2">
<h3 id="_viewing_currently_running_queries">Viewing currently running queries</h3>
<div class="paragraph">
<p>Inspecting the log file for queries that completed in more than XX milliseconds provides historical information, but what if you suspect that a query is running too long or is hung?</p>
</div>
<div class="paragraph">
<p>In the <em>Introduction to Neo4j</em> course you learned that long-running Cypher queries can be monitored  and killed from a Neo4j browser session. There is a difference between a query that runs in the Neo4j instance for a long time and a query that has run an returns a large result set. You should focus on the queries that run for a long time. In Neo4j Browser you can use the <code>:queries</code> command to see all currently running queries:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/ListQueriesBrowser.png" alt="ListQueriesBrowser" width="1000">
</div>
</div>
<div class="paragraph">
<p>In <code>cypher-shell</code> you execute <code>CALL dbms.listQueries() YIELD username, queryId, query, elapsedTimeMillis;</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/ListQueriesCypher-shell.png" alt="ListQueriesCypher-shell" width="1000">
</div>
</div>
<div class="paragraph">
<p>Another useful statement, you can used to view long-running queries and any type of transaction running in the Neo4j instance is by calling <code>dbms.listTransactions()</code> which you will use in the next Exercise.</p>
</div>
<div class="paragraph">
<p>If you have the <em>admin</em> role, you can view (and kill) queries from all users.</p>
</div>
</div>
<div class="sect2">
<h3 id="_killing_a_long_running_query">Killing a long-running query</h3>
<div class="paragraph">
<p>Recall that a user (or application) that issues a long-running query may not be able to stop the query. You would need to intervene and kill the query for the user.</p>
</div>
<div class="paragraph">
<p>Once you have identified the long-running query that you want to kill, in Neo4j Browser, you can kill it by double-clicking the icon in the <em>Kill</em> column.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/KillQueryBrowser.png" alt="KillQueryBrowser" width="1000">
</div>
</div>
<div class="paragraph">
<p>Alternatively, in <code>cypher-shell</code> you can execute the statement <code>CALL dbms.killQuery('query-id');</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/KillQueryCypher-shell.png" alt="KillQueryCypher-shell" width="1000">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_exercise_1_monitoring_queries"><strong>Exercise #1: Monitoring queries</strong></h3>
<div class="paragraph">
<p>In this Exercise, you enable query logging where an event will be written to the <strong>query.log</strong> file for a query that took more than 1000ms to complete. Then you will monitor and detect a long-running query and kill it.</p>
</div>
<div class="paragraph">
<p><strong>Before you begin:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>For this exercise, you will be using the stand-alone Neo4j instance that you configured for authentication in the previous lesson.</p>
</li>
<li>
<p>In a terminal window, modify the <strong>neo4j.conf</strong> file for the stand-alone Neo4j instance to use the <strong>movie3.db</strong>, rather than the <strong>crimes.db</strong>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Exercise steps</strong>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Modify the <strong>neo4j.conf</strong> file to create a log record if a query exceeds 1000 ms.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L05-Ex1-LogQueriesTooLong.png" alt="L05-Ex1-LogQueriesTooLong" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Start/restart the Neo4j stand-alone instance.</p>
</li>
<li>
<p>Open a new terminal window and log in to <code>cypher-shell</code> with the <em>reader/reader</em> credentials. (<strong>Suggestion</strong>: specify --format plain)</p>
</li>
<li>
<p>In this <code>cypher-shell</code> session, enter the following statement which will execute a query that runs for longer than 1000 ms: <code>MATCH (a), (b), (c), (d) RETURN count(id(a));</code></p>
</li>
<li>
<p>Wait about a minute, it should complete.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L05-Ex1-LongQuery.png" alt="L05-Ex1-LongQuery" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p>In the terminal window where you started the Neo4j instance, view the <strong>query.log</strong>. Is there a record for this query?</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L05-Ex1-QueryLog.png" alt="L05-Ex1-QueryLog" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="7">
<li>
<p>In <code>cypher-shell</code> session for <em>reader</em>, enter a query that will execute for an even longer period of time:  <code>MATCH (a), (b), (c), (d), (e) RETURN count(id(a));</code>.</p>
</li>
<li>
<p>Open a new terminal window and log in to cypher-shell with the <em>admin/admin</em> credentials. (<strong>Suggestion</strong>: specify --format plain)</p>
</li>
<li>
<p>In this second <em>admin</em> <code>cypher-shell</code> session, execute the Cypher statement to list transactions. Do you see the query from <em>reader</em>?</p>
</li>
<li>
<p>Then execute the same statement returning the username, currentQueryId, currentQuery, and elapsedTimeMillis.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L05-Ex1-ListTransactions.png" alt="L05-Ex1-ListTransactions" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="11">
<li>
<p>In the second <em>admin</em> <code>cypher-shell</code> session, execute the Cypher statement to kill the long-running query.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L05-Ex1-KillQuery.png" alt="L05-Ex1-KillQuery" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="11">
<li>
<p>Observe in the <em>reader_</em> <code>cypher-shell</code> session that the query has been killed.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_automating_monitoring_of_queries">Automating monitoring of queries</h3>
<div class="paragraph">
<p>Some queries against the Neo4j instance are not simply queries, but are Cypher statements that load data from CSV files. These types of Cypher statements could take a considerable amount of time to complete. One option for you to help automate the killing of long-running queries is to create a script that executes a Cypher statement such as the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CALL dbms.listQueries() YIELD query, elapsedTimeMillis, queryId, username
WHERE  NOT query CONTAINS toLower('LOAD')
AND elapsedTimeMillis &gt; 30000
WITH query, collect(queryId) AS q
CALL dbms.killQueries(q) YIELD queryId
RETURN query, queryId;</pre>
</div>
</div>
<div class="paragraph">
<p>This Cypher statement will retrieve all queries that are running for longer than 30000 ms that do not perform a LOAD operation and kill them. You could place this code into a script that is run at regular intervals.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_monitoring_transactions">Monitoring transactions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the previous Exercise, you saw that you can query the Neo4j instance for currently running queries, as well as currently running transactions. Transactions and their successful completion are important for any production Neo4j instance. As an administrator, you must be able to confirm through monitoring and configuration settings that transactions are completing within a specified period of time.</p>
</div>
<div class="paragraph">
<p>A transaction is either a read-only transaction or a read-write transaction. Read-only transactions never block other clients as they acquire <em>share</em> locks, but can take a long period of time to execute as you saw in the previous Exercise. A read-write transaction acquires <em>exclusive</em> locks during the transaction and may be blocked by other transactions that have acquired <em>exclusive</em> locks on the same resources. In some scenarios, a deadlock could occur if one transaction is blocked and is also blocking another transaction from acquiring the exclusive locks it needs.</p>
</div>
<div class="paragraph">
<p>In a multi-user read-write transactional application, you should should configure the Neo4j instance so that a transaction will be aborted if it cannot obtain <em>exclusive</em> locks after a certain period of time. This will eliminate a deadlock situation.</p>
</div>
<div class="paragraph">
<p>In addition, you should configure an upper limit for how long a transaction can run. This will depend on your particular application, but it should be set to a value that is greater than the lock timeout value. This is called a <em>transaction guard</em> which is a good thing in a production system. In fact, you can use <em>transaction guard</em> to automatically kill queries that take longer than xx minutes to execute.</p>
</div>
<div class="paragraph">
<p>Here is an example of the configuration settings for lock acquisition timeout and <em>transaction guard</em> where the transaction will fail if it exceeds one second or the request waits more than 10 milliseconds to acquire a write lock:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># transaction guard: max duration of any transaction
dbms.transaction.timeout=1s
# max time to acquire write lock
dbms.lock.acquisition.timeout=10ms</pre>
</div>
</div>
<div class="paragraph">
<p>When a lock timeout occurs or when a transaction times out, the client will receive an error and a record is written to the <strong>debug.log</strong> file.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you set a transaction timeout without setting the lock timeout, the client session may be deadlocked and the transaction cannot be terminated. This is why it is important to set <span class="underline">both</span> of these properties in your Neo4j configuration.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_exercise_2_monitoring_transactions"><strong>Exercise #2: Monitoring transactions</strong></h3>
<div class="paragraph">
<p>In this Exercise, you configure Neo4j to <span class="underline">not</span> allow transactions that take longer than one second to complete.</p>
</div>
<div class="paragraph">
<p><strong>Before you begin:</strong></p>
</div>
<div class="paragraph">
<p>For this exercise, you will be using the stand-alone Neo4j instance that you used in the previous Exercise.</p>
</div>
<div class="paragraph">
<p><strong>Exercise steps</strong>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Modify the <strong>neo4j.conf</strong> file to terminate transactions where the client cannot obtain a write lock after 10 milliseconds or the transaction time exceeds 1 second.</p>
</li>
<li>
<p>Start or restart the Neo4j instance.</p>
</li>
<li>
<p>In a terminal window, log in to <code>cypher-shell</code> with the credentials <em>publisher/publisher</em>.</p>
</li>
<li>
<p>Enter this Cypher statement which will attempt to execute a write transaction to create a million <em>Person</em> nodes: <code>FOREACH (i IN RANGE(1,1000000) | CREATE (:Person {name:'Person' + i}));</code>. Do you receive an error?</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L05-Ex2-LongTransactionTimeOut.png" alt="L05-Ex2-LongTransactionTimeOut" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>View the record written to <strong>debug.log</strong>.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L05-Ex2-LongTransactionTimeOutLog.png" alt="L05-Ex2-LongTransactionTimeOutLog" width="800">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you attempt to create more than a million <em>Person</em> nodes, you will run into other problems, most notably, running out of virtual memory in the Neo4j instance. You will learn about configuring virtual memory later in this lesson.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_monitoring_locks">Monitoring locks</h3>
<div class="paragraph">
<p>You can query the Neo4j instance&#8217;s currently running transactions. If you see transactions that are running for a long time, you can further query the Neo4j instance to determine what locks each long-running query is holding. To read more about monitoring locks, see this <a href="https://support.neo4j.com/hc/en-us/articles/360006827474-How-to-diagnose-locking-issues">Neo4j Support Knowledge Base article</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_monitoring_connections">Monitoring connections</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A Neo4j instance (stand-alone or in a Causal Cluster) uses a set of ports for inter-cluster communication as well as client communication. When you configure the Neo4j instance, you should ensure that the configured ports are available and are not blocked by a firewall.</p>
</div>
<div class="paragraph">
<p>The default ports used by a Neo4j instance are documented in the <a href="https://neo4j.com/docs/operations-manual/3.5/configuration/ports/">Neo4j Operations Manual</a>. And you have learned that you can modify the port numbers used by a Neo4j instance. In fact, for a secure Neo4j application, you should <span class="underline">not</span> use any default port numbers.</p>
</div>
<div class="paragraph">
<p>As an administrator, you can view the current connections to a Neo4j instance from <code>cypher-shell</code> by executing the call to <code>dbms.listConnections();</code>:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/listConnections.png" alt="listConnections" width="800">
</div>
</div>
<div class="paragraph">
<p>The connection with the userAgent value of <em>neo4j-java/dev</em> is the cypher-shell session. Any connections that are <em>javascript</em> are from the Web interface to Neo4j Browser. The other connections are for a <em>java</em> application. You could write a query to screen for connections from certain IP addresses that are forbidden. How you identify these IP addresses will depend on your security administrator for your application.</p>
</div>
<div class="paragraph">
<p>With <code>dbms.listConnections()</code>, you can identify a connection that:</p>
</div>
<div class="ulist square">
<ul class="square">
<li>
<p>has been connected to the Neo4j instance for too long a time period.</p>
</li>
<li>
<p>is from a user that you do not want connecting to the Neo4j instance.</p>
</li>
<li>
<p>is from a suspect IP address.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You terminate the connection to the Neo4j instance with a call to <code>dbms.killConnection()</code> where you can provide the connection ID or a comma-separated list of connection IDs with the format <code>['connectID-xx','connectID-yy']</code>.</p>
</div>
<div class="sect2">
<h3 id="_exercise_3_monitoring_connections"><strong>Exercise #3: Monitoring connections</strong></h3>
<div class="paragraph">
<p>In this Exercise, you access the Neo4j instance from multiple clients and monitor the connections.</p>
</div>
<div class="paragraph">
<p><strong>Before you begin:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that you have exited out of any <code>cypher-shell</code> sessions.</p>
</li>
<li>
<p>Download the writeApp java application zip file located <a href="https://s3-us-west-1.amazonaws.com/data.neo4j.com/admin-neo4j/writeApp.zip">here</a>. <strong>Hint</strong>: Enter <code>wget <a href="https://s3-us-west-1.amazonaws.com/data.neo4j.com/admin-neo4j/writeApp.zip" class="bare">https://s3-us-west-1.amazonaws.com/data.neo4j.com/admin-neo4j/writeApp.zip</a></code>.</p>
</li>
<li>
<p>Unzip <strong>writeApp.zip</strong> which will create the folder <strong>writeApp</strong>.</p>
</li>
<li>
<p>Make sure the <strong>write.sh</strong> has execute permissions (<code>chmod +x write.sh</code>)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Exercise steps</strong>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In a terminal window, log in to <code>cypher-shell</code> with the credentials <em>admin/admin</em>.</p>
</li>
<li>
<p>Enter the Cypher statement to list all connections to the Neo4j instance.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L05-Ex3-ListConnections1.png" alt="L05-Ex3-ListConnections1" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>In a different terminal window, log in to <code>cypher-shell</code> with the credentials <em>publisher/publisher</em>.</p>
</li>
<li>
<p>Enter the Cypher statement to list all connections to the Neo4j instance. Do you only see the connections for your user ID?</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L05-Ex3-ListConnections2.png" alt="L05-Ex3-ListConnections2" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>In the first <em>admin</em> <code>cypher-shell</code> session, enter the Cypher statement to list all connections to the Neo4j instance.  Do you see all of the connections?</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L05-Ex3-ListConnections3.png" alt="L05-Ex3-ListConnections3" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p>In a third terminal window navigate to the <strong>writeApp</strong> folder you created when you unzipped the java application.</p>
</li>
<li>
<p>Enter <code>./write.sh localhost 7687</code>. This java application will open a connection to the Neo4j instance and will ask you to press <strong>Enter</strong> to continue. Do <span class="underline">not</span> press <strong>Enter</strong>.</p>
</li>
<li>
<p>In the <em>admin</em> <code>cypher-shell</code> session, enter the Cypher statement to list all connections.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L05-Ex3-ListConnections4.png" alt="L05-Ex3-ListConnections4" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="9">
<li>
<p>In the <em>admin</em> <code>cypher-shell</code> session, enter the Cypher statement to kill the java client connections for <em>publisher</em>.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L05-Ex3-KillConnection.png" alt="L05-Ex3-KillConnection" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="10">
<li>
<p>In the window where the write Java application is waiting for you to press <strong>Enter</strong>, press the <strong>Enter</strong> key. You should see a message that the connection was closed.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L05-Ex3-KillConnection2.png" alt="L05-Ex3-KillConnection2" width="800">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_logging_http_requests">Logging HTTP requests</h3>
<div class="paragraph">
<p>You may want to monitor requests that come into the Neo4j instance from browser clients as these types of requests are typically not part of an application, but rather a user connecting to the server with their credentials.</p>
</div>
<div class="paragraph">
<p>You can set this property in <strong>neo4j.conf</strong> to log these requests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># To enable HTTP logging, uncomment this line
dbms.logs.http.enabled=true</pre>
</div>
</div>
<div class="paragraph">
<p>With HTTP logging enabled, you will see records for each HTTP request so you should also limit the number of log files to keep and their sizes. Part of your monitoring might be to look for certain patterns in the <strong>HTTP.log</strong> file(s) and in particular, requests made from IP addresses that you may not want accessing the instance.</p>
</div>
</div>
<div class="sect2">
<h3 id="_exercise_4_monitoring_http_requests"><strong>Exercise #4: Monitoring HTTP requests</strong></h3>
<div class="paragraph">
<p>In this Exercise, you enable the Neo4j instance for logging HTTP requests and monitor them.</p>
</div>
<div class="paragraph">
<p><strong>Before you begin:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that you have exited out of any cypher-shell sessions.</p>
</li>
<li>
<p>Stop the Neo4j instance.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Exercise steps</strong>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In a terminal window, modify the Neo4j configuration to log HTTP requests.</p>
</li>
<li>
<p>Start the Neo4j instance.</p>
</li>
<li>
<p>In a browser, connect to the Neo4j instance using port 7474. Connect to the server as <em>reader/reader</em>.</p>
</li>
<li>
<p>View the schema of the database by executing: <code>CALL db.schema();</code></p>
</li>
<li>
<p>View the records in the <strong>HTTP.log</strong> file.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L05-Ex4-HTTPLog.png" alt="L05-Ex4-HTTPLog" width="1200">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_monitoring_memory_usage">Monitoring memory usage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are many properties that you can set to control how the Neo4j instance executes at runtime. The default values provided in the <strong>neo4j.conf</strong> file are useful for a small database with a small number of connections. In a production environment and in a Causal Cluster environment, you must make sure that the settings for the JVM are the best ones for your particular application.</p>
</div>
<div class="paragraph">
<p>This training does not teach about performance tuning, but it introduces you to how memory is used by a Neo4j instance and how you can perform basic monitoring of memory usage.</p>
</div>
<div class="paragraph">
<p>In a JVM, memory is consumed by a number of internals:</p>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-middle"><strong>JVM Memory Usage</strong></th>
<th class="tableblock halign-left valign-middle"><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle" style="background-color: white;"><p class="tableblock">Heap</p></td>
<td class="tableblock halign-left valign-middle" style="background-color: white;"><p class="tableblock">The heap is where your Class instantiations or “Objects” are stored.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle" style="background-color: white;"><p class="tableblock">Thread stacks</p></td>
<td class="tableblock halign-left valign-middle" style="background-color: white;"><p class="tableblock">Each thread has its own call stack. The stack stores primitive local variables and object references along with the call stack (list of method invocations) itself. The stack is cleaned up as stack frames move out of context so there is no GC performed here.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle" style="background-color: white;"><p class="tableblock">Metaspace</p></td>
<td class="tableblock halign-left valign-middle" style="background-color: white;"><p class="tableblock">Metaspace stores the Class definitions of your Objects, and some other metadata.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle" style="background-color: white;"><p class="tableblock">Code cache</p></td>
<td class="tableblock halign-left valign-middle" style="background-color: white;"><p class="tableblock">The JIT compiler stores native code it generates in the code cache to improve performance by reusing it.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle" style="background-color: white;"><p class="tableblock">Garbage Collection</p></td>
<td class="tableblock halign-left valign-middle" style="background-color: white;"><p class="tableblock">In order for the GC to know which objects are eligible for collection, it needs to keep track of the object graphs. So this is one part of the memory lost to this internal bookkeeping.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle" style="background-color: white;"><p class="tableblock">Buffer Pools</p></td>
<td class="tableblock halign-left valign-middle" style="background-color: white;"><p class="tableblock">Many libraries and frameworks allocate buffers outside of the heap to improve performance. These buffer pools can be used to share memory between Java code and native code, or map regions of a file into memory.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p></p>
</div>
<div class="sect2">
<h3 id="_memory_consumption_of_a_neo4j_instance">Memory consumption of a Neo4j instance</h3>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/Neo4j-memoryConsumption.png" alt="Neo4j-memoryConsumption" width="800">
</div>
</div>
<div class="paragraph">
<p>A Neo4j instance consumes memory as follows:</p>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-middle"><strong>Neo4j Instance Memory Usage</strong></th>
<th class="tableblock halign-left valign-middle"><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle" style="background-color: white;"><p class="tableblock">Heap</p></td>
<td class="tableblock halign-left valign-middle" style="background-color: white;"><p class="tableblock">The JVM has a heap that is the runtime data area from which memory for all class instances and arrays are allocated. Heap storage for objects is reclaimed by an automatic storage management system (known as a garbage collector or GC).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle" style="background-color: white;"><p class="tableblock">Off-heap</p></td>
<td class="tableblock halign-left valign-middle" style="background-color: white;"><p class="tableblock">Off-heap refers to objects that are managed by EHCache, but stored outside the heap (and also not subject to GC). As the off-heap store continues to be managed in memory, it is slightly slower than the on-heap store, but still faster than the disk store.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle" style="background-color: white;"><p class="tableblock">Page cache</p></td>
<td class="tableblock halign-left valign-middle" style="background-color: white;"><p class="tableblock">The page cache lives off-heap and is used to cache the Neo4j data (and native indexes). The caching of graph data and indexes into memory will help avoid costly disk access and result in optimal performance.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>Heap allocation is where the runtime data resides including query execution, graph management, and transaction state.</p>
</div>
<div class="sect3">
<h4 id="_initial_memory_settings_for_a_database">Initial memory settings for a database</h4>
<div class="paragraph">
<p>The amount of memory the Neo4j instance will need may change over time and will depend on the growth of the database, as well as the number and types of queries against the database.</p>
</div>
<div class="paragraph">
<p>Initially, you can obtain a recommendation for property settings related to memory from information in the database using the <code>memrec</code> command of <code>neo4j-admin</code>:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/Neo4j-memrec.png" alt="Neo4j-memrec" width="1000">
</div>
</div>
<div class="paragraph">
<p>This tool provides recommended memory settings based upon information in your database and also information about available memory on your system.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_monitoring_memory_consumption">Monitoring memory consumption</h3>
<div class="paragraph">
<p>If you suspect that there is a memory issue with your Neo4j instance, you should temporarily turn on GC logging in the Neo4j configuration: <code>dbms.logs.gc.enabled=true</code>.  In addition, records will be written to <strong>debug.log</strong> if an out of memory event occurs in the Neo4j instance. When trying to resolve out of memory issues with your application, you should work with Neo4j Technical Support to determine the cause and solution of the problem.</p>
</div>
<div class="paragraph">
<p>One way that you can monitor memory usage for a running Neo4j instance is with the <code>jcmd</code> utility which is described in this <a href="https://support.neo4j.com/hc/en-us/articles/360014270873-Understanding-memory-consumption">Neo4j KB article</a>. To monitor memory usage with this utility, you must set <code>dbms.jvm.additional=-XX:NativeMemoryTracking=detail</code> in your Neo4j configuration.</p>
</div>
<div class="paragraph">
<p>Here is an example of a <code>jcmd</code> execution to get summary information about memory usage on the system:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/jcmd.png" alt="jcmd" width="800">
</div>
</div>
<div class="paragraph">
<p>If you suspect that certain parts of the application or a transaction is consuming too much memory, you can run <code>jcmd</code> to get a baseline, and then run it again to compare the differences in memory consumption as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>jcmd &lt;PID for Neo4j instance&gt; VM.native_memory baseline
// wait for some time during transaction
jcmd &lt;PID for Neo4j instance&gt; VM.native_memory summary.diff</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
In order to use jcmd for a Neo4j instance, you must ensure that the instance is started with the <code>dbms.jvm.additional</code> property set and you must run it as the user <em>neo4j</em>.  <strong>Hint</strong>: <code>sudo su - neo4j</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Refer to the <a href="https://neo4j.com/docs/operations-manual/3.5/performance/">Neo4j Operations Manual</a> for guidance about configuring memory, indexes, etc. for the Neo4j instance. In a production environment, you should work with Neo4j technical support to ensure that you are monitoring memory usage and have the appropriate settings. The <em>Performance</em> section of the documentation has guidelines that you should consider when configuring your Neo4j instance that are beyond the scope of this training.</p>
</div>
</div>
<div class="sect2">
<h3 id="_exercise_5_monitoring_a_memory_issue"><strong>Exercise #5: Monitoring a memory issue</strong></h3>
<div class="paragraph">
<p>In this Exercise, you will execute a query that exhausts memory, then you will configure memory settings for the Neo4j instance and execute the query again.</p>
</div>
<div class="paragraph">
<p><strong>Before you begin:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that you have exited out of any <code>cypher-shell</code> sessions.</p>
</li>
<li>
<p>Stop the Neo4j instance.</p>
</li>
<li>
<p>Modify the Neo4j configuration to <span class="underline">not</span> time out if a query takes a long time to execute. Simply comment out the settings you set previously in Exercise 2.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Exercise steps</strong>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start the Neo4j instance.</p>
</li>
<li>
<p>In <code>cypher-shell</code>, connect to the Neo4j instance as <em>publisher/publisher</em>.</p>
</li>
<li>
<p>Enter the following Cypher statement that will attempt to create 1.3 million <em>Person</em> nodes: <code>FOREACH (i IN RANGE(1,1300000) | CREATE (:Person {name:'Person' + i}));</code>.</p>
</li>
<li>
<p>Wait a few minutes. Eventually, you should receive an error.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L05-Ex5-OutOfMemory.png" alt="L05-Ex5-OutOfMemory" width="1000">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>View the the Neo4j log <strong>Hint</strong>: journalctl -e -u neo4j on Debian. It should also have an error logged as well as an error in <strong>debug.log</strong>.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L05-Ex5-OutOfMemory2.png" alt="L05-Ex5-OutOfMemory2" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p>Exit out of <code>cypher shell</code>.</p>
</li>
<li>
<p>Stop the Neo4j instance. It may take a few minutes to stop the Neo4j instance as it is cleaning up the transaction log.</p>
</li>
<li>
<p>Execute the command to display the memory requirements for your system specifing the current database which is <strong>movie3.db</strong>.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L05-Ex5-memrec.png" alt="L05-Ex5-memrec" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="9">
<li>
<p>If we want to add 1.3 million nodes to this database, we need to adjust the memory requirements to be at a minimum what we see from <code>memrec</code>.  In <strong>neo4j.conf</strong>, modify  <code>dbms.memory.heap.initial_size</code>, <code>dbms.memory.heap.max_size</code> , and <code>dbms.memory.pagecache.size</code> values to reflect what you see from <code>memrec</code>.</p>
</li>
<li>
<p>Restart the Neo4j instance. This may take a few minutes because the Neo4j instance is cleaning up the transaction log from the previous failed transaction.</p>
</li>
<li>
<p>Log in to <code>cypher-shell</code> as <em>publisher/publisher</em> and try the Cypher statement again that creates 1.3 million nodes.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L05-Ex5-success.png" alt="L05-Ex5-success" width="800">
</div>
</div>
<div class="paragraph">
<p><strong>Taking it further</strong>:</p>
</div>
<div class="paragraph">
<p>Perform the above steps while using <code>jcmd</code> to monitor memory consumption.</p>
</div>
<div class="paragraph">
<p>In your production application, you must work with developers and users of the application to understand the size of the transactions. You may need to temporarily set the heap and pagecache sizes higher during a special operation. In most cases, you will set these properties to a value that will be sufficient for all transactions. You must with with Neo4j Technical Support if you run into problems with running out of memory or even with starting the Neo4j instance. If the heap and pagecache sizes are too large, the Neo4j instance will not start.</p>
</div>
</div>
<div class="sect2">
<h3 id="_managing_log_files">Managing log files</h3>
<div class="paragraph">
<p>As an administrator, you will configure the Neo4j instance to log at the appropriate levels. In most production environments, you will archive log files so that they may be viewed at a later time as part of an auditing process or to troubleshoot a problem. Each type of log file (if configured to use) should have its maximum size defined, as well as the number of log files to keep.</p>
</div>
<div class="listingblock">
<div class="content">
<pre># Number of HTTP logs to keep.
#dbms.logs.http.rotation.keep_number=5

# Size of each HTTP log that is kept.
#dbms.logs.http.rotation.size=20m

# Number of query logs to keep.
#dbms.logs.query.rotation.keep_number=5

# Size of each query log that is kept.
#dbms.logs.query.rotation.size=20m

# Number of GC logs to keep.
#dbms.logs.gc.rotation.keep_number=5

# Size of each GC log that is kept.
#dbms.logs.gc.rotation.size=20m

# Size threshold for rotation of the debug log. If set to zero then no rotation will occur. Accepts a binary suffix "k",
# "m" or "g".
#dbms.logs.debug.rotation.size=20m

# Maximum number of history files for the internal log.
#dbms.logs.debug.rotation.keep_number=7

# Threshold for rotation of the security log.
#dbms.logs.security.rotation.size=20m

# Minimum time interval after last rotation of the security log before it may be rotated again.
#dbms.logs.security.rotation.delay=300s

# Maximum number of history files for the security log.
#dbms.logs.security.rotation.keep_number=7</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_collecting_metrics">Collecting metrics</h3>
<div class="paragraph">
<p>The Neo4j instance automatically collects metrics in the default location for metrics (for example, on Debian, all metrics are placed in <strong>/var/lib/neo4j/metrics</strong>). If for some reason, you do not want metrics collected, you can disable them by setting <code>metrics.enabled=false</code> in the Neo4j configuration.</p>
</div>
<div class="paragraph">
<p>All metrics are written to CSV files in the <strong>metrics</strong> directory. With these files, you can use a visualization tool to view historical or current metrics for the Neo4j instance.</p>
</div>
<div class="paragraph">
<p>There are other options for collecting and viewing metrics which are described in the <a href="https://neo4j.com/docs/operations-manual/3.5/monitoring/metrics/">Neo4j Operations Manual</a> which include:</p>
</div>
<div class="ulist square">
<ul class="square">
<li>
<p>Publishing to an endpoint using the Graphite protocol.</p>
</li>
<li>
<p>Publishing to an endpoint using the Prometheus protocol.</p>
</li>
<li>
<p>Querying the Neo4j instance using <code>dbms.queryJMX</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://halin.graphapp.io/">Halin</a> has been developed for querying the Neo4j instance. Here are a couple of screen shots when using Halin for viewing metrics:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/Halin1.png" alt="Halin1" width="800">
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/Halin2.png" alt="Halin2" width="800">
</div>
</div>
<div class="sect3">
<h4 id="_using_jmx_queries">Using JMX queries</h4>
<div class="paragraph">
<p>A Neo4j instance can be monitored with Java Management Extensions (JMX). JMX is a low-level mechanism for monitoring the Neo4j instance. However, a best practice is <span class="underline">not</span> to use it for remote monitoring as it is a security vulnerability. In addition, running a tool such as <code>jconsole</code> that uses JMX can use production system resources which is also not recommended.</p>
</div>
<div class="paragraph">
<p>Neo4j supports the use of JMX in Cypher queries. This is something that is safe to do remotely and does not consume resources locally.</p>
</div>
<div class="paragraph">
<p>For example, here is a rather long Cypher statement that retrieves the same information that you would expect to see when you run the <code>:sysinfo</code> command in Neo4j browser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CALL dbms.queryJmx("org.neo4j:instance=kernel#0,name=Store file sizes") YIELD attributes
       WITH  keys(attributes) AS k , attributes
       UNWIND k AS row
       RETURN "StoreSizes" AS type,row,attributes[row]["value"]

UNION ALL

CALL dbms.queryJmx("org.neo4j:instance=kernel#0,name=Page cache") YIELD attributes
       WITH  keys(attributes) AS k , attributes
       UNWIND k AS row
       RETURN "PageCache" AS type,row,attributes[row]["value"]

UNION ALL

CALL dbms.queryJmx("org.neo4j:instance=kernel#0,name=Primitive count") YIELD attributes
       WITH  keys(attributes) AS k , attributes
       UNWIND k AS row
       RETURN "ID Allocations" AS type,row,attributes[row]["value"]

UNION ALL

CALL dbms.queryJmx("org.neo4j:instance=kernel#0,name=Transactions") YIELD attributes
       WITH  keys(attributes) AS k , attributes
       UNWIND k AS row
       RETURN "Transactions" AS type,row,attributes[row]["value"]

UNION ALL

CALL dbms.queryJmx("org.neo4j:instance=kernel#0,name=High Availability") YIELD attributes
       WITH  keys(attributes) AS k , attributes
       UNWIND k AS row
       RETURN "High Availability" AS type,row,attributes[row]["value"]

UNION ALL

CALL dbms.queryJmx("org.neo4j:instance=kernel#0,name=Causal Clustering") YIELD attributes
       WITH  keys(attributes) AS k , attributes
       UNWIND k AS row
       RETURN "Causal Cluster" AS type,row,attributes[row]["value"];</pre>
</div>
</div>
<div class="paragraph">
<p>Here is the result of executing this Cypher statement:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/CypherJMX.png" alt="CyperJMX" width="800">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_6_querying_with_jmx"><strong>Exercise #6: Querying with JMX</strong></h4>
<div class="paragraph">
<p>In this Exercise, you will execute a JMX query to view metrics about the Neo4j instance.</p>
</div>
<div class="paragraph">
<p><strong>Before you begin:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure you have a started Neo4j instance.</p>
</li>
<li>
<p>Open a terminal window.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Exercise steps</strong>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log in to the Neo4j instance with <code>cypher-shell</code> using the credentials <em>publisher/publisher</em>.</p>
</li>
<li>
<p>Execute the Cypher statement shown above for querying for metrics.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L05-Ex6-CypherJMX1.png" alt="L05-Ex6-CypherJMX1" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Execute the Cypher statement for creating 1.3 million nodes: <code>FOREACH (i IN RANGE(1,1300000) | CREATE (:Person {name:'Person' + i}));</code>.</p>
</li>
<li>
<p>Execute the Cypher statement shown above for querying for metrics.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L05-Ex6-CypherJMX2.png" alt="L05-Ex6-CypherJMX2" width="800">
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_check_your_understanding">Check your understanding</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_question_1">Question 1</h3>
<div class="paragraph">
<p>What Cypher statements can you run to determine if a query is taking too long to execute?</p>
</div>
<div class="paragraph">
<p>Select the correct answers.</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="false-answer">CALL dbms.getStats();</span></p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="false-answer">CALL dbms.listStats();</span></p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="required-answer">CALL dbms.listTransactions();</span></p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="required-answer">CALL dbms.listQueries();</span></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_question_2">Question 2</h3>
<div class="paragraph">
<p>What tool can you use to determine how much virtual memory you should configure for the Neo4j instance?</p>
</div>
<div class="paragraph">
<p>Select the correct answer.</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="false-answer">jcmd</span></p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="false-answer">vmstat</span></p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="required-answer">neo4j-admin memrec</span></p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="false-answer">neo4j-admin analyze</span></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_question_3">Question 3</h3>
<div class="paragraph">
<p>How can Neo4j metrics be collected?</p>
</div>
<div class="paragraph">
<p>Select the correct answers.</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="required-answer">Placed in CSV files for tools to use.</span></p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="required-answer">Publish to an endpoint using the Graphite protocol.</span></p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="required-answer">Publish to an endpoint using the Prometheus protocol.</span></p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="required-answer">Queried using dbms.queryJMX().</span></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You should now be able to:</p>
</div>
<div class="ulist square">
<ul class="square">
<li>
<p>Describe the categories of monitoring and measurement you can perform with Neo4j.</p>
</li>
<li>
<p>Monitor:</p>
<div class="ulist">
<ul>
<li>
<p>queries</p>
</li>
<li>
<p>transactions</p>
</li>
<li>
<p>connections</p>
</li>
<li>
<p>memory usage</p>
</li>
</ul>
</div>
</li>
<li>
<p>Manage log files.</p>
</li>
<li>
<p>Manage the collection of Neo4j metrics.</p>
</li>
<li>
<p>Use JMX queries.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-02-22 11:29:27 CST
</div>
</div>
</body>
</html>