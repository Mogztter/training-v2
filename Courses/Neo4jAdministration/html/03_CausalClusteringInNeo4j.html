<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.7.1">
<title>Causal Clustering in Neo4j</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote::before{display:none}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{word-spacing:0;line-height:1.6}
.quoteblock.abstract blockquote::before,.quoteblock.abstract p::before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Causal Clustering in Neo4j</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_about_this_module">About this module</a></li>
<li><a href="#_what_is_clustering">What is Clustering?</a>
<ul class="sectlevel2">
<li><a href="#_cluster_architecture">Cluster architecture</a>
<ul class="sectlevel3">
<li><a href="#_core_servers">Core servers</a></li>
<li><a href="#_read_replica_servers">Read replica servers</a></li>
<li><a href="#_distributed_architecture">Distributed architecture</a></li>
</ul>
</li>
<li><a href="#_how_causal_consistency_works">How causal consistency works</a></li>
</ul>
</li>
<li><a href="#_configuring_clustering">Configuring clustering</a>
<ul class="sectlevel2">
<li><a href="#_core_server_startup">Core server startup</a></li>
<li><a href="#_core_server_shutdown">Core server shutdown</a></li>
<li><a href="#_core_server_updates_database">Core server updates database</a></li>
</ul>
</li>
<li><a href="#_initial_administrative_tasks_for_clustering">Initial administrative tasks for clustering</a>
<ul class="sectlevel2">
<li><a href="#_configuring_core_servers">Configuring core servers</a>
<ul class="sectlevel3">
<li><a href="#_identify_core_servers">Identify core servers</a></li>
<li><a href="#_specify_cluster_membership">Specify cluster membership</a></li>
<li><a href="#_example_configuration_properties">Example: Configuration properties</a></li>
<li><a href="#_minimum_cluster_size_at_formation">Minimum cluster size at formation</a></li>
</ul>
</li>
<li><a href="#_how_runtime_minimum_is_used_for_a_cluster">How runtime minimum is used for a cluster</a></li>
<li><a href="#_starting_the_core_servers">Starting the core servers</a></li>
<li><a href="#_viewing_the_status_of_the_cluster">Viewing the status of the cluster</a></li>
<li><a href="#_using_the_neo4j_enterprise_edition_docker_image_for_this_training">Using the Neo4j Enterprise Edition Docker image for this training</a></li>
<li><a href="#_exercise_1_getting_started_with_clustering"><strong>Exercise #1: Getting started with clustering</strong></a></li>
</ul>
</li>
<li><a href="#_seeding_the_data_for_the_cluster">Seeding the data for the cluster</a>
<ul class="sectlevel2">
<li><a href="#_exercise_2_seeding_the_cluster_databases"><strong>Exercise #2: Seeding the cluster databases</strong></a></li>
</ul>
</li>
<li><a href="#_basic_routing_in_a_cluster">Basic routing in a cluster</a>
<ul class="sectlevel2">
<li><a href="#_exercise_3_accessing_the_core_servers_in_a_cluster"><strong>Exercise #3: Accessing the core servers in a cluster</strong></a></li>
</ul>
</li>
<li><a href="#_configuring_read_replica_servers">Configuring read replica servers</a>
<ul class="sectlevel2">
<li><a href="#_configuration_settings_for_read_replica_servers">Configuration settings for read replica servers</a></li>
<li><a href="#_read_replica_server_startup">Read replica server startup</a></li>
<li><a href="#_read_replica_server_shutdown">Read replica server shutdown</a></li>
<li><a href="#_exercise_4_accessing_the_read_replica_servers_in_a_cluster"><strong>Exercise #4: Accessing the read replica servers in a cluster</strong></a></li>
</ul>
</li>
<li><a href="#_core_server_lifecycle">Core server lifecycle</a>
<ul class="sectlevel2">
<li><a href="#_monitoring_core_servers">Monitoring core servers</a></li>
<li><a href="#_helpful_configuration_settings">Helpful configuration settings</a></li>
<li><a href="#_exercise_5_understanding_quorum"><strong>Exercise #5: Understanding quorum</strong></a></li>
</ul>
</li>
<li><a href="#_clusters_in_many_physical_locations">Clusters in many physical locations</a>
<ul class="sectlevel2">
<li><a href="#_bookmarks">Bookmarks</a></li>
</ul>
</li>
<li><a href="#_backing_up_a_cluster">Backing up a cluster</a>
<ul class="sectlevel2">
<li><a href="#_exercise_6_backing_up_a_cluster"><strong>Exercise #6: Backing up a cluster</strong></a></li>
</ul>
</li>
<li><a href="#_check_your_understanding">Check your understanding</a>
<ul class="sectlevel2">
<li><a href="#_question_1">Question 1</a></li>
<li><a href="#_question_2">Question 2</a></li>
<li><a href="#_question_3">Question 3</a></li>
</ul>
</li>
<li><a href="#_summary">Summary</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
	<script type='text/javascript'>
	var loc = window.location;
	if (loc.hostname == "neo4j.com" && loc.search.indexOf("aliId=") == -1 ) {
	 loc.pathname = "/graphacademy/online-training/XXXX/"
	}
	document.write(unescape("%3Cscript src='//munchkin.marketo.net/munchkin.js' type='text/javascript'%3E%3C/script%3E"));
	</script>
	<script>Munchkin.init('773-GON-065');</script>
</div>
</div>
<div class="sect1">
<h2 id="_about_this_module">About this module</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that you have gained experience managing a Neo4j instance and database , you will learn how to get started with creating and managing Neo4j Causal Clusters.</p>
</div>
<div class="paragraph">
<p>At the end of this module, you should be able to:</p>
</div>
<div class="ulist square">
<ul class="square">
<li>
<p>Describe why you would use clusters.</p>
</li>
<li>
<p>Describe the components of a  cluster.</p>
</li>
<li>
<p>Configure and use a cluster.</p>
</li>
<li>
<p>Seed a cluster with data.</p>
</li>
<li>
<p>Monitor and manage core servers in the cluster.</p>
</li>
<li>
<p>Monitor and manage read replica servers in the cluster.</p>
</li>
<li>
<p>Back up a cluster.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This module covers the basics of clusters in Neo4j. Later in this training, you will learn more about security and encryption related to clusters.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_is_clustering">What is Clustering?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Neo4j&#8217;s clustering architecture enables an enterprise to utilize a Neo4j database in production. First, it provides a high-available solution whereby if a Neo4j instance has a failure, another Neo4j instance can take over automatically. Secondly, it provides a highly-scalable database whereby some parts of the application update the data, but other parts of the application are widely distributed and do not need immediate access to new or updated data. That is, read latency is acceptable. Causal consistency in Neo4j means that an application is guaranteed to be able to consistently read all data that it has written.</p>
</div>
<div class="paragraph">
<p>Most Neo4j applications use clustering to ensure high-availability. The scalability of the Neo4j database is used by applications that utilize multiple data centers.</p>
</div>
<div class="sect2">
<h3 id="_cluster_architecture">Cluster architecture</h3>
<div class="paragraph">
<p>There are two types of Neo4j instances in a cluster architecture: core servers and read replica servers.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/ClustersArchitecture.png" alt="ClustersArchitecture" width="600">
</div>
</div>
<div class="sect3">
<h4 id="_core_servers">Core servers</h4>
<div class="paragraph">
<p>Core servers are used for read and write access to the database. The core servers are used to synchronize updates to the database, regardless of the number and physical locations of the Neo4j instances. By default, in a cluster architecture, a transaction is committed if a majority (<em>quorum</em>) of the core servers defined as the minimum required for the cluster have written the data to the physical database.  This coordination  between core servers is implemented using the Raft protocol. You can have a large number of core servers, but the more core servers in the application architecture, the longer a "majority" commit will take. At a minimum, an application should use three core servers to be considered fault-tolerant. If one of the three servers fail, the cluster is still operable for updates to the database. If you want an architecture that can support two servers failing, then you must configure five core servers. You cannot configure a cluster with two core servers because if one server fails, the second server is automatically set to be read-only, leaving your database to be inoperable for updates.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/QuorumCommit.png" alt="QuorumCommit" width="800">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_read_replica_servers">Read replica servers</h4>
<div class="paragraph">
<p>Read replica servers are used to scale data across a distributed network. They only support read access to the data. The read replica servers regularly poll the core servers for updates to the database by obtaining the transaction log from a core server. You can think of a read replica as a highly scalable and distributed cache of the database.  If a read replica fails, a new read replica can be started with no impact on the data and just a slight impact for the application that can be written to re-connect to a different read replica server.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/ReadReplicasPoll.png" alt="ReadReplicasPoll" width="800">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_distributed_architecture">Distributed architecture</h4>
<div class="paragraph">
<p>Here is an example where the core servers are located in one data center, but the read replicas are located in many distributed data centers.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/DistributedClusterArchitecture.png" alt="DistributedClusterArchitecture" width="800">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_causal_consistency_works">How causal consistency works</h3>
<div class="paragraph">
<p>An application can create a bookmark that is used to mark the the last transaction committed to the database. In a subsequent read, the bookmark can be used to ensure that the appropriate core servers are used to ensure that only committed data will be read by the application.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/Bookmark.png" alt="Bookmark" width="800">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuring_clustering">Configuring clustering</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As an administrator, you must determine the physical locations of the servers that will be used as core servers and read replica servers.  You configure the casual cluster by updating the <strong>neo4j.conf</strong> file on each server so that they can operate together as a cluster. The types of properties that you configure for cluster include, but are not limited to:</p>
</div>
<div class="ulist square">
<ul class="square">
<li>
<p>Whether the server will be a core server or a read replica server</p>
</li>
<li>
<p>Public address for the server</p>
</li>
<li>
<p>Names/addresses of the servers in the core server membership</p>
</li>
<li>
<p>Ports used for communicating between the members</p>
</li>
<li>
<p>Published ports for bolt, http, https (non-conflicting port numbers)</p>
</li>
<li>
<p>Number of core servers in the cluster</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_core_server_startup">Core server startup</h3>
<div class="paragraph">
<p>When a core server starts, it first uses a discovery protocol to join the network. At some point it will be running with the other members of the core membership. In a cluster, exactly one core server is elected to b the <em>LEADER</em>. The <em>LEADER</em> is the coordinator of all communication between the core servers. All of the other core servers are <em>FOLLOWERS</em> as the servers in the cluster use the raft protocol to synchronize updates.  If a core server joins the network after the other core servers have been running and updating data, the late-joining core server must use the catchup protocol to get to a point where it is synchronized as the other <em>FOLLOWERS</em> are.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/Discovery.png" alt="Discovery" width="800">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_core_server_shutdown">Core server shutdown</h3>
<div class="paragraph">
<p>When a core server shuts down, the shutdown may be initiated by an administrator, or it may be due to a hardware or network failure. If the core server that is a <em>FOLLOWER</em> shuts down, the <em>LEADER</em> detects and incorporates into its operations with the other core servers. If the core server that is the <em>LEADER</em> shuts down, the remaining core servers communicate with each other and an existing <em>FOLLOWER</em> is promoted to the <em>LEADER</em>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/ServerShutdown.png" alt="ServerShutdown" width="800">
</div>
</div>
<div class="paragraph">
<p>If a core server shutdown leaves the cluster below a configured threshold for the number of core servers required for the cluster, then the <em>LEADER</em> becomes inoperable for writing to the database. This is a serious matter that needs to be addressed by you as the administrator.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/ClusterBelowQuorum.png" alt="ClusterBelowQuorum" width="800">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_core_server_updates_database">Core server updates database</h3>
<div class="paragraph">
<p>A core server updates its database based upon the requests from clients. The client&#8217;s transaction is not complete until a quorum of core servers have updated their databases. Subsequent to the completion of the transaction, the remaining core servers will also be updated. Core servers use a <em>raft protocol</em> to share updates. Application clients can use the <em>bolt</em> protocol to send updates to a particular core server&#8217;s database, but the preferred protocol for an cluster is the <em>bolt+routing</em> protocol. With this protocol, applications can write to any core server in the cluster, but the <em>LEADER</em> will always coordinate updates.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_initial_administrative_tasks_for_clustering">Initial administrative tasks for clustering</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here are some common tasks for managing and monitoring clustering:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Modify the <strong>neo4j.conf</strong> files for each core server.</p>
</li>
<li>
<p>Start the core servers in the cluster.</p>
</li>
<li>
<p>Seed the core server (add initial data).</p>
</li>
<li>
<p>Ensure each core server has the data.</p>
</li>
<li>
<p>Modify the <strong>neo4j.conf</strong> files for each read replica server.</p>
</li>
<li>
<p>Start the read replica servers.</p>
</li>
<li>
<p>Ensure each read replica server has the data.</p>
</li>
<li>
<p>Test updates to the database.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In your real application, you set up the core and read replica Neo4j instances on separate physical servers that are networked and where you have installed Enterprise Edition of Neo4j. In a real application, <span class="underline">all</span> configuration for clustering is done by modifying the <strong>neo4j.conf</strong> file.</p>
</div>
<div class="sect2">
<h3 id="_configuring_core_servers">Configuring core servers</h3>
<div class="paragraph">
<p>Please refer to the <a href="https://neo4j.com/docs/operations-manual/3.5/clustering/settings/">Neo4j Operations Manual</a> for greater detail about the settings for configuring clustering.</p>
</div>
<div class="sect3">
<h4 id="_identify_core_servers">Identify core servers</h4>
<div class="paragraph">
<p>When setting up clustering, you should first identify at least three machines that will host core servers. For these machines, you should make sure these properties are set in <strong>neo4j.conf</strong> where XXXX is the IP address of the machine on the network and XXX1, XXX2, XXX3 are the IP addresses of the machines that will participate in the cluster. These machines must be network accessible.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/IdentifyMachines.png" alt="IdentifyMachines" width="800">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_specify_cluster_membership">Specify cluster membership</h4>
<div class="paragraph">
<p>The machines that you designate to run core servers must be reachable from each other. This means that the core machines are part of the membership of the cluster:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/ClusterMembers.png" alt="ClusterMembers" width="800">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_example_configuration_properties">Example: Configuration properties</h4>
<div class="paragraph">
<p>Here are some of the settings that you may use for your core servers, depending on whether the addresses are known in the network. You may have to specify advertised addresses in addition to the actual addresses.</p>
</div>
<div class="listingblock">
<div class="content">
<pre># set this if you want to ensure the host can be accessed from external browsers
dbms.connectors.default_listen_address=0.0.0.0

# these are the default values used for virtually all configs
dbms.connector.https.listen_address=0.0.0.0:7473
dbms.connector.http.listen_address=0.0.0.0:7474
dbms.connector.bolt.listen_address=0.0.0.0:7687

# used by application clients for accessing the instance
dbms.connector.bolt.advertised_address=localhost:18687

causal_clustering.transaction_listen_address=0.0.0.0:6000
causal_clustering.transaction_advertised_address=XXXX:6000

causal_clustering.raft_listen_address=0.0.0.0:7000
causal_clustering.raft_advertised_address=XXXX:7000

causal_clustering.discovery_listen_address=0.0.0.0:5000
causal_clustering.discovery_advertised_address=XXXX:5000

# all members of the cluster must have this same list
causal_clustering.initial_discovery_members=XXX1:5000,XXX2:5000,XXX3:5000,XXX4:5000,XXX5:5000

# 3 is the default if you do not specify these properties
causal_clustering.minimum_core_cluster_size_at_formation=3
causal_clustering.minimum_core_cluster_size_at_runtime=3

dbms.mode=CORE</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_minimum_cluster_size_at_formation">Minimum cluster size at formation</h4>
<div class="paragraph">
<p>The <em>minimum_core_cluster_size_at_formation</em> property specifies the number of core servers that must be running before the database is operable for updates. These core servers, when started, ensure that they are caught up with each other. After all core servers are caught up, then the cluster is operable for updates.</p>
</div>
<div class="paragraph">
<p>The <em>minimum_core_cluster_size_at_runtime</em> property specifies the number of servers that will actively participate in the cluster at runtime.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_runtime_minimum_is_used_for_a_cluster">How runtime minimum is used for a cluster</h3>
<div class="paragraph">
<p>If the number of core servers started at formation is greater than the number required at runtime, then some started core servers are not considered essential and the cluster can still be operable if some of the core servers stop running.  Most deployments set these two properties to be the same.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/RuntimeMinimum.png" alt="RuntimeMinimum" width="800">
</div>
</div>
<div class="paragraph">
<p>The minimum number of core servers at runtime in a fault-tolerant cluster is three, which is the default setting for clustering.  If you require more than three core servers, you must adjust the values in the clustering configuration section where you specify the size and the members of the cluster.</p>
</div>
</div>
<div class="sect2">
<h3 id="_starting_the_core_servers">Starting the core servers</h3>
<div class="paragraph">
<p>After you have modified the <strong>neo4j.conf</strong> files for the cluster, you start each Neo4j instance. When you start a set of core servers, it doesn&#8217;t matter what order they are started. The cluster is not considered <em>started</em> until the number of core servers specified in <em>causal_clustering.minimum_core_cluster_size_at_formation</em>. One of the members of the core group will automatically be elected as the <em>LEADER</em>.  Note that which core server is the <em>LEADER_</em> could change at any time. You should observe the log output for each core server instance to ensure that it started with no errors.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
There is a configuration property (<em>causal_clustering.refuse_to_be_leader</em>) that you can set to true in the <strong>neo4j.conf</strong> file that specifies that this particular core server will <span class="under">never</span> be a leader. It is <span class="underline">not</span> recommended that you set this property.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_viewing_the_status_of_the_cluster">Viewing the status of the cluster</h3>
<div class="paragraph">
<p>After you have started the core servers in the cluster, you can access status information about the cluster from <code>cypher-shell</code> on any of the core servers in the cluster. You simply enter <code>CALL dbms.cluster.overview();</code> and it returns information about the servers in the cluster, specifically, which ones are followers and which one is the leader.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/clusterOverview.png" alt="clusterOverview" width="1000">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_neo4j_enterprise_edition_docker_image_for_this_training">Using the Neo4j Enterprise Edition Docker image for this training</h3>
<div class="paragraph">
<p>For this training, you will gain experience managing and monitoring clustering using Docker. You will create and run Docker containers using a Neo4j Enterprise Docker image. This will enable you to start and manage multiple Neo4j instances used for clustering on your local machine.
The published Neo4j Enterprise Edition 3.5.0 Docker image (from DockerHub.com) is pre-configured so that its instances can be easily replicated in a Docker environment that uses clustering. Using a Docker image, you create Docker containers that run on your local system. Each Docker container is a Neo4j instance.</p>
</div>
<div class="paragraph">
<p>For example, here are the settings in the <strong>neo4j.conf</strong> file for the Neo4j instance container named <em>core3</em> when it starts as a Docker container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>#********************************************************************
# Other Neo4j system properties
#********************************************************************
dbms.jvm.additional=-Dunsupported.dbms.udc.source=tarball
wrapper.java.additional=-Dneo4j.ext.udc.source=docker
ha.host.data=core3:6001
ha.host.coordination=core3:5001
dbms.tx_log.rotation.retention_policy=100M size
dbms.memory.pagecache.size=512M
dbms.memory.heap.max_size=512M
dbms.memory.heap.initial_size=512M
dbms.connectors.default_listen_address=0.0.0.0
dbms.connector.https.listen_address=0.0.0.0:7473
dbms.connector.http.listen_address=0.0.0.0:7474
dbms.connector.bolt.listen_address=0.0.0.0:7687
causal_clustering.transaction_listen_address=0.0.0.0:6000
causal_clustering.transaction_advertised_address=core3:6000
causal_clustering.raft_listen_address=0.0.0.0:7000
causal_clustering.raft_advertised_address=core3:7000
causal_clustering.discovery_listen_address=0.0.0.0:5000
causal_clustering.discovery_advertised_address=core3:5000
EDITION=enterprise
ACCEPT.LICENSE.AGREEMENT=yes</pre>
</div>
</div>
<div class="paragraph">
<p>Some of these settings are for applications that use the <em>high availability (ha)</em> features of Neo4j. With clustering, we use the core servers for fault-tolerance rather than the high availability features of Neo4j. The setting <em>dbms.connectors.default_listen_address=0.0.0.0</em> is important. This setting enables the instance to communicate with other applications and servers in the network (for example, using a Web browser to access the http port for the server). Notice that the instance has a number of <em>causal_clustering</em> settings that are pre-configured. These are default settings for clustering that you can override when you create the Docker container for the first time. Some of the other default settings are recommended settings for a Neo4j instance, whether it is part of a cluster or not.</p>
</div>
<div class="paragraph">
<p>When you create Docker Neo4j containers using <code>docker run</code>, you specify additional clustering configuration as parameters, rather than specifying them in the <strong>neo4j.conf</strong> file. Here is an example of the parameters that are specified when creating the Docker container named <em>core3</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>docker run --name=core3 \
        --volume=`pwd`/core3/conf:/conf --volume=`pwd`/core3/data:/data --volume=`pwd`/core3/logs:/logs  \
        --publish=13474:7474 --publish=13687:7687 \
 	    --env=NEO4J_dbms_connector_bolt_advertised__address=localhost:13687 \
        --network=training-cluster \
        --env=NEO4J_ACCEPT_LICENSE_AGREEMENT=yes  \
	    --env=NEO4J_causal__clustering_minimum__core__cluster__size__at__formation=3 \
        --env=NEO4J_causal__clustering_minimum__core__cluster__size__at__runtime=3 \
        --env=NEO4J_causal__clustering_initial__discovery__members=core1:5000,core2:5000,core3:5000,core4:5000,core5:5000 \
        --env=NEO4J_dbms_mode=CORE \
	   --detach \
        b4ca2f886837</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the name of the Docker container is <em>core3</em>. We map the conf, data, and logs folders for the Neo4j instance when it starts to our local filesystem. We map the http and bolt ports to values that will be unique on our system (13474 and 13687). We specify the bolt address to use. The name of the Docker network that is used for this cluster is <em>training-cluster</em>. <em>ACCEPT_LICENSE_AGREEMENT</em> is required. The size of the cluster is three core servers and the names of the [potential] members are specified as <em>core1</em>, <em>core2</em>, <em>core3</em>, core4_, and <em>core5</em>. These servers use port 5000 for the discovery listen address. This instance will be used as a core server (dbms.mode=CORE). The container is started in this script detached, meaning that no output or interaction will be produced. And finally the ID of the Neo4j Enterprise 3.5.0 container is specified. When you specify the Neo4j parameters for starting the container (<code>docker run</code>), you always prefix them with "--env=NEO4J_". In addition, you specify "<em>"  for "."  and  "_</em>"  for "_" instead of what you would use in the Neo4j configuration file.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
When using the Neo4j Docker instance, a best practice is to specify more members in the cluster, but not require them to be started when the cluster forms. This will enable you to later add core servers to the cluster.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_exercise_1_getting_started_with_clustering"><strong>Exercise #1: Getting started with clustering</strong></h3>
<div class="paragraph">
<p>In this Exercise, you will gain experience with a simple cluster using Docker containers.  You will <span class="underline">not</span> use Neo4j instances running on your system, but rather Neo4j instances running in Docker containers.</p>
</div>
<div class="paragraph">
<p><strong>Before you begin</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ensure that Docker Desktop (MAC/Windows) or Docker CE (Debian) is installed (<code>docker --version</code>). Here is information about <a href="https://hub.docker.com/search/?type=edition&amp;offering=community">downloading and installing Docker</a>.</p>
</li>
<li>
<p>Download the file <a href="https://s3-us-west-1.amazonaws.com/data.neo4j.com/admin-neo4j/neo4j-docker.zip">neo4j-docker.zip</a> and unzip it to a folder that will be used to saving Neo4j configuration changes for clusters. This will be your working directory for the cluster Exercises in this training. <strong>Hint:</strong> <code>curl -O <a href="https://s3-us-west-1.amazonaws.com/data.neo4j.com/admin-neo4j/neo4j-docker.zip" class="bare">https://s3-us-west-1.amazonaws.com/data.neo4j.com/admin-neo4j/neo4j-docker.zip</a></code></p>
</li>
<li>
<p>Download the Docker image for Neo4j ( <code>docker pull neo4j:3.5.0-enterprise</code>).</p>
</li>
<li>
<p>Ensure that your user ID has docker privileges: <code>sudo usermod -aG docker &lt;username&gt;</code>. You will have to log in and log out to use the new privileges.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Exercise steps</strong>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a terminal on your system.</p>
</li>
<li>
<p>Confirm that you have the Neo4j 3.5.0 Docker image: <code>docker images</code></p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex1-DockerImages.png" alt="L03-Ex1-DockerImages" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Navigate to the neo4j-docker folder. This is the folder that will contain all configuration changes for the Neo4j instances you will be running in the cluster. Initially, you will be working with three core servers. Here you can see that you have a folder for each core server and each read replica server.</p>
</li>
<li>
<p>Examine the <strong>create_initial_cores.sh</strong> file. This script creates the network that will be used in your Docker environment and then creates three Docker container instances from the Neo4j image. Each instance will represent a core server. Finally, the script stops the three instances.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex1-create_cores.png" alt="L03-Ex1-create_cores" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>Run <strong>create_initial_cores.sh</strong> as root <code>sudo ./create_initial_cores.sh &lt;Image ID&gt;</code> providing as an argument the Image ID of the Neo4j Docker image.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex1-create_cores-run.png" alt="L03-Ex1-create_cores-run" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p>Confirm that the three containers exist: <code>docker ps -a</code></p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex1-containersCreated.png" alt="L03-Ex1-containersCreated" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="7">
<li>
<p>Open a terminal window for each of the core servers. (three of them)</p>
</li>
<li>
<p>In each core server window, start the instance: <code>docker start -a coreX</code>. The instance should be started. These instances are set up so that the default browser port on localhost will be 11474, 12474, and 13474. Notice that each instance uses it&#8217;s own database as the active database. For example, here is the result of starting the core server containers. Notice that each server starts as part of the cluster. The servers are not fully started until all catchup has been done between the servers and the <em>Started</em> record is shown. The databases will not be accessible by clients until <em>all</em> core members of the cluster have successfully started.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex1-CoresStarted.png" alt="L03-Ex1-CoresStarted" width="600">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="9">
<li>
<p>In your non-core server terminal window, confirm that all core servers are running in the network by typing <code>docker ps -a</code>.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex1-AllCoreServersStarted.png" alt="L03-Ex1-AllCoreServersStarted" width="1000">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="10">
<li>
<p>In your non-core server terminal window, log in to the core1 server with <code>cypher-shell</code> as follows <code>docker exec -it core1 /var/lib/neo4j/bin/cypher-shell -u neo4j -p neo4j</code></p>
</li>
<li>
<p>Change the password. Here is an example where we change the password for core1:</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex1-ChangePassword.png" alt="L03-Ex1-ChangePassword" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="12">
<li>
<p>repeat the previous two steps for core2 and core3 to change the password for the <em>neo4j</em> user.</p>
</li>
<li>
<p>Log in to any of the servers and get the cluster overview information in <code>cypher-shell</code>. In this image, <em>core1</em> is the <em>LEADER</em>:</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex1-ClusterOverview.png" alt="L03-Ex1-ClusterOverview" width="1000">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="14">
<li>
<p>Shut down all core servers by typing this in a non-core server terminal window: <code>docker stop core1 core2 core3</code></p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex1-StopCores.png" alt="L03-Ex1-StopCores" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="15">
<li>
<p>You can now close the terminal windows you used for each of the core servers,  but keep the non-core server window open.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You have now successfully configured, started, and accessed core servers (as Docker containers) running in a causal cluster.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_seeding_the_data_for_the_cluster">Seeding the data for the cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When setting up a cluster for your application, you must ensure that the database that will be used in the cluster has been populated with your application data. In a cluster, each Neo4j instance has its own database, but the data in the databases for each core server that is actively running in the cluster is identical.</p>
</div>
<div class="paragraph">
<p>Before you seed the data for <span class="underline">each</span> core server that is part of a cluster, you must unbind it from the cluster. To unbind the core server, the instance must be stopped, then you run <code>neo4j-admin unbind --database=&lt;database-name</code>.</p>
</div>
<div class="paragraph">
<p>When you seed the data for the cluster, you can do any of the following, but you must do the same on <span class="underline">each</span> of the core servers of the cluster to create the production database. Note that the core servers must be down for these tasks. You learned how to do these tasks in the previous module.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Restore data using an online backup.</p>
</li>
<li>
<p>Load data using an offline backup.</p>
</li>
<li>
<p>Create data using the import tool and a set of <strong>.csv</strong> files.</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/Seeding.png" alt="Seeding" width="800">
</div>
</div>
<div class="paragraph">
<p>If the the amount of application data is relatively small (less than 10M nodes) you can also load <strong>.csv</strong> data into a running core server in the cluster where all core servers are started and actively part of the cluster. This will propagate the data to all databases in the cluster.</p>
</div>
<div class="sect2">
<h3 id="_exercise_2_seeding_the_cluster_databases"><strong>Exercise #2: Seeding the cluster databases</strong></h3>
<div class="paragraph">
<p>In this Exercise, you will populate the databases in the cluster that you created earlier. Because you are using Docker containers for learning about clustering, you cannot perform the normal seeding procedures as you would in your real production environment because when using the Neo4j Docker containers, the Neo4j instance is already started when you start the container. Instead, you will simply start the core servers in the cluster and connect to <span class="underline">one of them</span>. Then you will use <code>cypher-shell</code> to load the <em>Movie</em> data into the database.</p>
</div>
<div class="paragraph">
<p><strong>Before you begin</strong></p>
</div>
<div class="paragraph">
<p>Ensure that you have performed the steps in Exercise 1 where you set up the core servers as Docker containers. Note that you can perform the steps of this exercise in a single terminal window.</p>
</div>
<div class="paragraph">
<p><strong>Exercise steps</strong>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In a terminal window, start the core servers:  <code>docker start core1 core2 core3</code>. This will start the core servers in background mode where the log is not attached to STDOUT. If you want to see what is happening with a particular core server, you can always view the messages in <strong>&lt;coreX&gt;/logs/debug.log</strong>.</p>
</li>
<li>
<p>By default, all writes must be performed by the <em>LEADER</em> of the cluster.  Determine which core server is the <em>LEADER</em>. <strong>Hint:</strong> You can do this by logging in to any core server that is running (<code>docker exec -it &lt;core server&gt; /bin/bash</code>) and entering the following command: <code>echo "CALL dbms.cluster.overview();" | /var/lib/neo4j/bin/cypher-shell -u neo4j -p training-helps</code>. In this example, core1 is the <em>LEADER</em>:</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex2-Core1IsLeader.png" alt="L03-Ex2-Core1IsLeader" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Log in to the core server that is the <em>LEADER</em>.</p>
</li>
<li>
<p>Run <code>cypher-shell</code> specifying that the <strong>movie.cypher</strong> statements will be run. <strong>Hint:</strong> You can do this with a single command line: <code>/var/lib/neo4j/bin/cypher-shell -u neo4j -p training-helps &lt; /var/lib/neo4j/data/movieDB.cypher</code></p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex2-LoadMovieData.png" alt="L03-Ex2-LoadMovieData" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>Log in to <code>cypher-shell</code> and confirm that the data has been loaded into the database.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex2-Data-loaded.png" alt="L03-Ex2-Data-loaded" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p>Log out of the core server.</p>
</li>
<li>
<p>Log in to a <em>FOLLOWER</em> core server with <code>cypher-shell</code>. <strong>Hint:</strong> For example, you can log in to core2 with <code>cypher-shell</code> with the following command: <code>docker exec -it core2 /var/lib/neo4j/bin/cypher-shell -u neo4j -p training-helps</code></p>
</li>
<li>
<p>Verify that the <em>Movie</em> data is in the database for this core server.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex2-Core2-loaded.png" alt="L03-Ex2-Core2-loaded" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="9">
<li>
<p>Log out of the core server.</p>
</li>
<li>
<p>Log in to the remaining core server that is the <em>FOLLOWER</em> with <code>cypher-shell</code>.</p>
</li>
<li>
<p>Verify that the <em>Movie</em> data is in the database for this core server.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex2-Core3-loaded.png" alt="L03-Ex2-Core3-loaded" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="12">
<li>
<p>Log out of the core server.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You have now seen the cluster in action. Any modification to one database in the core server cluster is propagated to the other core servers.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_basic_routing_in_a_cluster">Basic routing in a cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In a cluster, all write operations must be coordinated by the <em>LEADER</em> in the cluster. Which core server is designated as the <em>LEADER</em> could change at any time in the event of a failure or a network slowdown. Applications that access the database can automatically route their write operations to whatever <em>LEADER</em> is available as this functionality is built into the Neo4j driver libraries. The Neo4j driver code obtains the routing table and automatically updates it as necessary if the endpoints in the cluster change.  To implement the automatic routing, application clients that will be updating the database must use the <em>bolt+routing</em> protocol when they connect to any of the core servers in the cluster.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/Routing.png" alt="Routing" width="800">
</div>
</div>
<div class="paragraph">
<p>Applications that update the database should <span class="underline">always</span> use <em>bolt+routing</em> when accessing the core servers in a cluster. Using this protocol, applications gain:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Automatic routing to an available server.</p>
</li>
<li>
<p>Load balancing of requests between the available servers.</p>
</li>
<li>
<p>Automatic retries.</p>
</li>
<li>
<p>Causal chaining (bookmarks)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, if you have a cluster with three core servers and <em>core1</em> is the <em>LEADER</em>, your application can only write to <em>core1</em> using the <em>bolt</em> protocol and bolt port for <em>core1</em>. An easy way to see this restriction is if you use the default address for <code>cypher-shell</code> on the system where a <em>FOLLOWER</em> is running. If you connect via <code>cypher-shell</code> to the server on <em>core2</em> and attempt to update the database, you receive an error:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/CannotWriteFollower.png" alt="CannotWriteFollower" width="800">
</div>
</div>
<div class="paragraph">
<p>When using clustering, <span class="underline">all</span> application code that updates the application should use the <em>bolt+routing</em> protocol which will enable applications to be able to write to the database, even in the event of a failure of one of the core servers. Applications should be written with the understanding that transactions are automatically retried.</p>
</div>
<div class="sect2">
<h3 id="_exercise_3_accessing_the_core_servers_in_a_cluster"><strong>Exercise #3: Accessing the core servers in a cluster</strong></h3>
<div class="paragraph">
<p>In this Exercise, you gain some experience with <em>bolt+routing</em> by running two stand-alone Java applications: one that reads from the database and one that writes to the database.</p>
</div>
<div class="paragraph">
<p><strong>Before you begin</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ensure that you have performed the steps in Exercise 2 where you have populated the database used for the cluster and all three core servers are running. Note that you can perform the steps of this exercise in a single terminal window.</p>
</li>
<li>
<p>Ensure that the three core servers are started.</p>
</li>
<li>
<p>Log out of the core server if you have not done so already. You should be in a terminal window where you manage Docker.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Exercise steps</strong>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate to the <strong>neo4j-docker/testApps</strong> folder.</p>
</li>
<li>
<p>There are three Java applications as well as scripts for running them. These scripts enable you to run a read-only client or write client against the database where you specify the protocol and the port for connecting to the Neo4j instance. Unless you modified port numbers in the <strong>create_initial_cores.sh</strong> script when you created the containers, the bolt ports used for core1, core2, and core3 are 11687, 12687, and 13687 respectively. What this means is that clients can read from the database using these ports using the <em>bolt</em> protocol. Try running <strong>testRead.sh</strong>, providing bolt as the protocol and one of the above port numbers. For example, type <code>./testRead.sh bolt 12687</code>. You should be able to successfully read from each server. Here is an example of running the script against the core2 server which currently is a <em>FOLLOWER</em> in the cluster:</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex3_ReadFollower.png" alt="L03-Ex3_ReadFollower" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Next, run the script against the other servers in the network. All reads should be successful.</p>
</li>
<li>
<p>Next, run the <strong>testWrite.sh</strong> script against the same port using the <em>bolt</em> protocol. For example, type <code>./testWrite.sh bolt 11687</code>. What you should see is that you can only use the <em>bolt</em> protocol for writing against the <em>LEADER</em>.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex3_WriteLeaderFollower.png" alt="L03-Ex3_WriteLeaderFollower" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>Next, change the protocol from <em>bolt</em> to <em>bolt+routing</em> and write to the core servers that are <em>FOLLOWER</em> servers.  For example, type <code>./testWrite.sh bolt+routing 12687</code>. With this protocol, all writes are routed to the <em>LEADER</em> and the application can write to the database.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex3_AllCanWriteLeader.png" alt="L03-Ex3_AllCanWriteLeader" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p>Next, you will add data to the database with a client that sends the request to a <em>FOLLOWER</em> core server. Run the <strong>addPerson.sh</strong> script against any port  representing a <em>FOLLOWER</em> using the <em>bolt</em> protocol. For example, type <code>./addPerson.sh bolt+routing 13687 "Willie"</code>. This will add a <em>Person</em> node to the database for core3.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex3_AddPerson.png" alt="L03-Ex3_AddPerson" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="7">
<li>
<p>Verify that this newly-added <em>Person</em> node is written to the other servers in the cluster by using the <em>bolt</em> protocol to request specific servers. For example, type <code>./readPerson.sh bolt 12687 "Willie"</code> to confirm that the data was added to core2.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex3_ReadPerson.png" alt="L03-Ex3_ReadPerson" width="800">
</div>
</div>
<div class="paragraph">
<p>You have now seen how updates to the core servers in a cluster must be coordinated by the server that is currently the <em>LEADER</em> and how reads and writes are performed in a cluster using the <em>bolt</em> and <em>bolt+routing</em> protocols.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuring_read_replica_servers">Configuring read replica servers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You configure read replica servers on host systems where you want the data to be distributed. Read replica servers know about the cluster, but whether they are running or not has no effect on the health of the cluster. In a production environment, you can add many read replicas to the cluster. They will have no impact on the performance of the cluster.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/ConfiguringReadReplicas.png" alt="ConfiguringReadReplicas" width="800">
</div>
</div>
<div class="sect2">
<h3 id="_configuration_settings_for_read_replica_servers">Configuration settings for read replica servers</h3>
<div class="paragraph">
<p>Here are the configuration settings you use for a read replica server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>dbms.connectors.default_listen_address=0.0.0.0

dbms.connector.https.listen_address=0.0.0.0:7473
dbms.connector.http.listen_address=0.0.0.0:7474
dbms.connector.bolt.listen_address=0.0.0.0:7687

dbms.connector.bolt.advertised_address=localhost:18687 ?????Question for SME: what do we do on a real system

causal_clustering.initial_discovery_members=XXX1:5000,XXX2:5000,XXX3:5000,XXX4:5000,XXX5:5000

dbms.mode=CORE</pre>
</div>
</div>
<div class="paragraph">
<p>Just like the configuration for a core server, you must specify the bolt advertised address, as well as the addresses for the servers that are the members of the cluster. However, you can add as many read replica servers and they will not impact the functioning of the cluster.</p>
</div>
</div>
<div class="sect2">
<h3 id="_read_replica_server_startup">Read replica server startup</h3>
<div class="paragraph">
<p>There can be many read replica servers in a cluster. When they start, they register with a core server that maintains a shared whiteboard (cache) that can be used by multiple read replica servers. As part of the startup process, the read replica catches up to the core server. The read replicas do not use the <em>raft protocol</em>. Instead they poll the core servers to obtain the updates to the database that they must apply locally.</p>
</div>
<div class="paragraph">
<p>Here is what you would see if you had a cluster with three core servers and two read replica servers running:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/ThreeCoresAndTwoReplicas.png" alt="ThreeCoresAndTwoReplicas" width="1000">
</div>
</div>
<div class="paragraph">
<p>Unlike core servers where applications use <em>bolt+routing</em> to access the database, clients of read replica servers use <em>bolt</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_read_replica_server_shutdown">Read replica server shutdown</h3>
<div class="paragraph">
<p>Since the read replica servers are considered "transient", when they shut down, there is no effect to the operation of the cluster. Of course, detection of a shutdown when it is related to a hardware or network failure must be detected so that a new read replica server can be started as clients  depend on read access can continue their work.</p>
</div>
</div>
<div class="sect2">
<h3 id="_exercise_4_accessing_the_read_replica_servers_in_a_cluster"><strong>Exercise #4: Accessing the read replica servers in a cluster</strong></h3>
<div class="paragraph">
<p>In this Exercise, you will see how replica servers can be used to retrieve changed data from the core servers.</p>
</div>
<div class="paragraph">
<p><strong>Before you begin</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ensure that the three core servers are started.</p>
</li>
<li>
<p>Open a terminal window where you will be managing Docker containers.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Exercise steps</strong>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate to <strong>neo4j-docker</strong>.</p>
</li>
<li>
<p>Run the script to create the initial replica servers, providing the Image ID of the Neo4j Docker image.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex4_CreateReplicaServers.png" alt="L03-Ex4_CreateReplicaServers" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Start replica1 and replica2: <code>docker start replica1 replica2</code>.</p>
</li>
<li>
<p>Log in to each of read replica server and change the password.</p>
</li>
<li>
<p>Use Cypher to retrieve the cluster overview. For example in a terminal window type: <code>docker exec -it replica2 /var/lib/neo4j/bin/cypher-shell -u neo4j -p training-helps  "CALL dbms.cluster.overview();"</code>. Do you see all three core servers and the two read replica servers?</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex4_Overview.png" alt="L03-Ex4_Overview" width="1000">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p>Navigate to the <strong>neo4j-docker/testApps</strong> folder.</p>
</li>
<li>
<p>Run the <strong>addPerson.sh</strong> script against any port for a core server using the <em>bolt+routing</em> protocol. For example, type <code>./addPerson.sh bolt+routing 13687 "Kong"</code>. This will add a <em>Person</em> node to the database.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex4_AddPerson.png" alt="L03-Ex4_AddPerson" width="1000">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="8">
<li>
<p>Verify that this newly-added <em>Person</em> node is readable by a read replica server in the cluster by using the <em>bolt</em> protocol to request specific servers. For example, type <code>./readPerson.sh bolt 22687 "Kong"</code> to confirm that the data is available.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex4_ReadPerson.png" alt="L03-Ex4_ReadPerson" width="1000">
</div>
</div>
<div class="paragraph">
<p>You have now seen how updates to the core servers in a cluster must be coordinated by the server that is currently the <em>LEADER</em> and how reads and writes are performed in a cluster using the <em>bolt</em> and <em>bolt+routing</em> protocols against the core servers and reads are performed in a cluster using the <em>bolt</em> protocol against the read replica servers.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_core_server_lifecycle">Core server lifecycle</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <em>minimum_core_cluster_size_at_runtime</em> property specifies the number of servers that will actively participate in the cluster at runtime. The number of core servers that start and join the cluster is used to calculate what the <em>quorum</em> is for the cluster. For example, if the number of core servers started is three, then quorum is two. If the number of core servers started is four, then quorum is three. If the number of core server stated is five, then quorum is three. Quorum is important in a cluster as it dictates the behavior of the cluster when core servers are added to or removed from the cluster at runtime.</p>
</div>
<div class="paragraph">
<p>As an administrator, you must understand which core servers are participating in the cluster and in particular, what the current <em>quorum</em> is for the cluster.</p>
</div>
<div class="paragraph">
<p>If a core server shuts down, the cluster can still operate provided the number of core servers is equal to or greater than <em>quorum</em>. For example, if the current number of core servers is three, <em>quorum</em> is two. Provided the cluster has two core servers, it is considered operational for updates. If the cluster maintains quorum, then it is possible to add a different core server to the cluster since a quorum must exist for voting in a new core server.</p>
</div>
<div class="paragraph">
<p>If the <em>LEADER</em> core server shuts down, then one of the other <em>FOLLOWER</em> core servers assumes the role of <em>LEADER</em>, provided a quorum still exists for the cluster. If a cluster is left with only <em>FOLLOWER</em> core servers, this is because <em>quorum</em> no longer exists and as a result,the database is read-only.  As an administrator, you must ensure that your cluster always has a <em>LEADER</em>.</p>
</div>
<div class="paragraph">
<p>The core servers that are used to start the cluster (membership) are important. Only core servers that originally participated in the cluster can be running in order to add a new core server to the cluster.</p>
</div>
<div class="paragraph">
<p>Follow this video to understand the life-cycle of a cluster and how <em>quorum</em> is used for fault-tolerance for a cluster:</p>
</div>
<iframe width="560" height="315" src="https://www.youtube.com/embed/0ug7Cpswjio" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<div class="paragraph">
<p>If a core server goes down and you cannot restart it, you have two options:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start a new core server that has not yet been part of the cluster, but is specified in the membership list of the cluster. This will only work if the cluster currently has a quorum so the existing core servers can vote to add the core server to the cluster.</p>
</li>
<li>
<p>Start a new parallel cluster with backup from current read only cluster.  This requires that client applications must adjust port numbers they use.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Option (1) is much easier so a best practice is to always specify additional hosts that could be used as replacement core servers in the membership list for a cluster. This will enable you to add core servers to the cluster without needing to stop the cluster.</p>
</div>
<div class="sect2">
<h3 id="_monitoring_core_servers">Monitoring core servers</h3>
<div class="paragraph">
<p>In addition to using Cypher to retrieve the overview state of the cluster, there are also REST APIs for accessing information about a particular server.  For example, you can query the status of the cluster as follows: <code>curl -u neo4j:training-helps localhost:11474/db/manage/server/causalclustering/status</code> where the query is made against the core1 server:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/RESTStatus.png" alt="RESTStatus" width="1000">
</div>
</div>
<div class="paragraph">
<p>Or if you want to see it a particular server is writable (part of a "healthy" cluster), for example, you can get that information as follows: <code>curl -u neo4j:training-helps localhost:11474/db/manage/server/causalclustering/writable</code> where the query is made against the core1 server:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/RESTWritable.png" alt="RESTWritable" width="1000">
</div>
</div>
<div class="paragraph">
<p>Using the REST API enables you as an administrator to script checks against the cluster to ensure that it is running properly and available to the clients.</p>
</div>
</div>
<div class="sect2">
<h3 id="_helpful_configuration_settings">Helpful configuration settings</h3>
<div class="paragraph">
<p>The Neo4j Operations Manual documents many properties that are related to clusters. Here are a few you may want to consider for your deployment:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>causal_clustering.enable_prevoting</em> set to <code>TRUE</code> can reduce the number of <em>LEADER</em> switches, especially when a new member is introduced to the cluster.</p>
</li>
<li>
<p><em>causal_clustering.leader_election_timeout</em> can be set to a number of seconds (the default is 7s). The default is typically sufficient, but you may need to increase it slightly if your cluster startup is slower than normal.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_exercise_5_understanding_quorum"><strong>Exercise #5: Understanding quorum</strong></h3>
<div class="paragraph">
<p>In this Exercise, you gain some experience monitoring the cluster as servers shut down and as servers are added.</p>
</div>
<div class="paragraph">
<p><strong>Before you begin</strong></p>
</div>
<div class="paragraph">
<p>Ensure that you have performed the steps in Exercise 4 and you have a cluster with core1, core2, ns core3 started, as well as replica1 and replica2.</p>
</div>
<div class="paragraph">
<p><strong>Exercise steps</strong>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>View the cluster overview using core1: <code>docker exec -it core1 /var/lib/neo4j/bin/cypher-shell -u neo4j -p training-helps  "CALL dbms.cluster.overview();"</code>. Make a note of which core server is the <em>LEADER</em>.  In this example, core3 is the <em>LEADER</em>.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex5_Overview.png" alt="L03-Ex5_Overview" width="1000">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Stop the core server that is the <em>LEADER</em>.</p>
</li>
<li>
<p>View the cluster overview using replica1: <code>docker exec -it replica1 /var/lib/neo4j/bin/cypher-shell -u neo4j -p training-helps  "CALL dbms.cluster.overview();"</code>. Do you see that another core server has assumed the <em>LEADER</em> role?</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex5_Core3Shutown.png" alt="L03-Ex5_Core3Shutown" width="1000">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p>In the testApps folder, run the script <strong>testWrite.sh</strong> providing the protocol of <em>bolt+routing</em> and a port for one of the core servers that is running.  Can the client write to the database?</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex5_WriteTwoCores.png" alt="L03-Ex5_WriteTwoCores" width="1000">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>Stop the core server that is the <em>LEADER</em>.</p>
</li>
<li>
<p>Confirm that the only core server running is now a <em>FOLLOWER</em>.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex5_OneCore.png" alt="L03-Ex5_OneCore" width="10000">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="7">
<li>
<p>Run the script to write to the database using <em>bolt+routing</em> and the port number for the remaining core server. Can you write to the database?</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex5_OneCoreNoWrite.png" alt="L03-Ex5_OneCoreNoWrite" width="1000">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="8">
<li>
<p>Start a core server that you previously stopped.</p>
</li>
<li>
<p>View the cluster overview. Is there now a <em>LEADER</em>? This cluster is operational because it now has a <em>LEADER</em></p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex5_NewLeader.png" alt="L03-Ex5_NewLeader" width="1000">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="10">
<li>
<p>The cluster is now back to quorum. What this means is that a new core server can be added (elected) that was not part of the original cluster.</p>
</li>
<li>
<p>Navigate to neo4j-docker and run the script to create core4, providing the Image ID of the Neo4j Docker image.</p>
</li>
<li>
<p>Start the core4 server.</p>
</li>
<li>
<p>Change the password of the core4 server.</p>
</li>
<li>
<p>Retrieve the overview information for the cluster. Does it have two <em>FOLLOWERS</em> and one <em>LEADER</em>? It was possible to add a new core server to the cluster because the cluster had a quorum and the core5 server was specified in the original configuration of the member list of the cluster.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex5_AddedCore4.png" alt="L03-Ex5_AddedCore4" width="1000">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_clusters_in_many_physical_locations">Clusters in many physical locations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Many large enterprises deploy large datasets that need to be distributed to many physical locations. To deploy a cluster to more than one physical location, a best practice is to host the core servers in one data center, and host the read replicas in another data center. Neo4j also supports hosting core servers in multiple locations.  To host Neo4j servers that are geographically distributed, you need a multi-data center license and you must configure it in your <strong>neo4j.conf</strong> file by setting the <em>multi_dc_license</em> property to <code>true</code>. When doing so, there is more configuration that you must do to ensure that clients are routed to the servers that are physically closest to them. You do this by configuring policy groups for your cluster. If policy groups have been configured for the servers, the application drivers instances must be created to use the policy groups. With policy groups, writes are always routed to the <em>LEADER</em>, but reads are routed to any <em>FOLLOWER</em> that is available. This enables to cluster and driver to automatically perform load balancing.</p>
</div>
<div class="paragraph">
<p><strong>NEW VIDEO on multi-dc here</strong></p>
</div>
<div class="paragraph">
<p>Read more about configuring clusters for multi-data center in the <a href="https://neo4j.com/docs/operations-manual/3.5/clustering/multi-data-center/">Operations Manual</a></p>
</div>
<div class="sect2">
<h3 id="_bookmarks">Bookmarks</h3>
<div class="paragraph">
<p>Both read and write client applications can create bookmarks within a session that enable them to quickly access a location in the database. The bookmarks can be passed between sessions. See the <a href="https://neo4j.com/docs/developer-manual/3.4/drivers/sessions-transactions/">Developer Manual</a> for details about writing code that uses bookmarks.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_backing_up_a_cluster">Backing up a cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The database for a cluster is backed up online. You must specify <code>dbms.backup.enabled=true</code> in the configuration for each core server in the cluster.</p>
</div>
<div class="paragraph">
<p>The core server can use its transaction port or the backup port for backup operations. You typically use the backup port. Here is the setting that you must add to the configuration:</p>
</div>
<div class="paragraph">
<p><code>dbms.backup.address=&lt;server-address&gt;:6362</code></p>
</div>
<div class="paragraph">
<p>A best practice is to create and use a read replica server for the backup. In doing so, the read replica server will be in catchup mode with the core servers but can ideally keep up with the committed transactions on the core servers. You can check to see what the last transaction ID is on a core server vs. a read replica by executing the Cypher statement: <code>CALL dbms.listTransactions() YIELD transactionId;</code> on each server. Each server will have a different last transaction ID, but as many transactions are performed against the cluster, you should see these values increasing at the same rate. If you find that the read replica is far behind in catching up, you may want to consider using a core server for the backup. If you use a core server for a backup, it could degrade performance of the cluster. If you want to use a core server for backup, you should increase the number of core servers in the cluster, for example from three to five.</p>
</div>
<div class="paragraph">
<p>For backing up a cluster, you must first decide which server and port will be used for the backup (backup client). You can backup using either a backup port or a transaction port. In addition, in a real application you will want the backup to be encrypted. For this you must use SSL. Security and encryption is covered later in this training.</p>
</div>
<div class="paragraph">
<p>You log in to the server from where you will be performing the backup (typically a read replica server) and then you perform the backup with these suggested settings:</p>
</div>
<div class="paragraph">
<p><code>neo4j-admin backup --backup-dir=&lt;backup-path&gt; --name=&lt;backup-name&gt; --from=&lt;core-server:backup-port&gt; --protocol=catchup --check-consistency=true</code></p>
</div>
<div class="paragraph">
<p>You can add more to the backup command as you can read about in the <a href="https://neo4j.com/docs/operations-manual/3.5/backup/causal-clusters/">Neo4j Operations Manual</a>.</p>
</div>
<div class="paragraph">
<p>In this example, we have logged in to the read replica server and we perform the backup using the address and backup port for the <em>LEADER</em>, <em>bcore3</em>. We also specify the location of the backup files and also that we want the backup to be checked for consistency.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/BackupFromReadReplica.png" alt="BackupFromReadReplica" width="1000">
</div>
</div>
<div class="paragraph">
<p>Note that this is not an encrypted backup. You will learn about encryption later in this training when you learn about security.</p>
</div>
<div class="sect2">
<h3 id="_exercise_6_backing_up_a_cluster"><strong>Exercise #6: Backing up a cluster</strong></h3>
<div class="paragraph">
<p>In this Exercise, you gain some experience backing up a cluster. Because the Docker containers are created without backup configured, in order to back up a cluster, you will need to create a different network that will be used for testing backups. Then you will create the core servers and read replica server to work with backing up the database.</p>
</div>
<div class="paragraph">
<p><strong>Before you begin</strong></p>
</div>
<div class="paragraph">
<p>Stop all core and read replica servers.</p>
</div>
<div class="paragraph">
<p><strong>Exercise steps</strong>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the <strong>neo4j-docker/backkup-work</strong> folder, there is a script called <strong>create_containers.sh</strong> that creates a new docker network named <em>test-backup-cluster</em>, creates three core servers: bcore1, bcore2, bcore3, and a read replica server, breplica1. Examine this script and notice that the core servers and the read replica server is configured for backup using the backup port. Any of the core servers can be used for the backup.</p>
</li>
<li>
<p>Run the script to create the containers specifying the Image ID of the Neo4j image.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex6_CreateContainers.png" alt="L03-Ex6_CreateContainers" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Start all of the servers and change the default password for each server.</p>
</li>
<li>
<p>Confirm that all core servers and the read replica are running in the cluster.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex6_ClusterFormed.png" alt="L03-Ex6_ClusterFormed" width="1000">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>Seed the cluster by loading the movie data into one of the core servers.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex6_SeedCluster.png" alt="L03-Ex6_SeedCluster" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p>Shut down all servers as you will be modifying their configurations to enable backups.</p>
</li>
<li>
<p>For each core servers, add these properties to the end of each <strong>neo4j.conf</strong> file where <em>X</em> is the bcore number:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>dbms.backup.enabled=true
dbms.backup.address=bcoreX:6362</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="8">
<li>
<p>Start the core servers and the read replica server.</p>
</li>
<li>
<p>Check the last transaction ID on the core server that is the <em>LEADER</em>.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex6_LastTXNCore.png" alt="L03-Ex6_LastTXNCore" width="1000">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="10">
<li>
<p>Log in to the read replica server and check the last transaction ID. This server will have a different last transaction ID, but in a real application, you will find that this ID value increases at the same rate as it increases in the core servers.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex6_LastTXNReadReplica.png" alt="L03-Ex6_LastTXNReadReplica" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="11">
<li>
<p>While still logged in to the read replica, create a subfolder under <strong>logs</strong> named <strong>backups</strong>.</p>
</li>
<li>
<p>Perform the backup using <code>neo4j-admin</code> specifying the <em>LEADER</em> port for the backup, use the <em>catchup</em> protocol, and place the backup the <strong>logs/backups</strong> folder, naming the backup <em>backup1</em>.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex6_Backup1.png" alt="L03-Ex6_Backup1" width="800">
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex6_Backup2.png" alt="L03-Ex6_Backup2" width="800">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="13">
<li>
<p>Confirm that the backup files were created.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="../img/L03-Ex6_BackupFiles.png" alt="L03-Ex6_BackupFiles" width="800">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_check_your_understanding">Check your understanding</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_question_1">Question 1</h3>
<div class="paragraph">
<p>Suppose you want to set up a cluster that can survive at least two failures and still be considered fault-tolerant. How many <em>LEADERS</em> and <em>FOLLOWERS</em> will this cluster have at a minimum?</p>
</div>
<div class="paragraph">
<p>Select the correct answer.</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="false-answer">One <em>LEADER</em> and two <em>FOLLOWERS</em></span></p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="required-answer">One <em>LEADER</em> and four <em>FOLLOWERS</em></span></p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="false-answer">Two <em>LEADERS</em> and three <em>FOLLOWERS</em></span></p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="false-answer">Two <em>LEADERS</em> and two <em>FOLLOWERS</em></span></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_question_2">Question 2</h3>
<div class="paragraph">
<p>What protocol should application clients use to update a database in the cluster?</p>
</div>
<div class="paragraph">
<p>Select the correct answer.</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="required-answer">bolt+routing</span></p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="false-answer">bolt</span></p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="false-answer">cluster+routing.</span></p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="false-answer">cluster</span></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_question_3">Question 3</h3>
<div class="paragraph">
<p>In a cluster, which servers have their own databases?</p>
</div>
<div class="paragraph">
<p>Select the correct answers.</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="required-answer">Core servers with the role of <em>LEADER</em></span></p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="required-answer">Core servers with the role of <em>FOLLOWER</em></span></p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="required-answer">Read replica servers</span></p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> <span class="false-answer">Primary server for the cluster</span></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You should now be able to:</p>
</div>
<div class="ulist square">
<ul class="square">
<li>
<p>Describe why you would use clusters.</p>
</li>
<li>
<p>Describe the components of a  cluster.</p>
</li>
<li>
<p>Configure and use a cluster.</p>
</li>
<li>
<p>Seed a cluster with data.</p>
</li>
<li>
<p>Monitor and manage core servers in the cluster.</p>
</li>
<li>
<p>Monitor and manage read replica servers in the cluster.</p>
</li>
<li>
<p>Back up a cluster.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-01-28 10:26:54 CST
</div>
</div>
</body>
</html>